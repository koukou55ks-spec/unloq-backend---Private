<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unloq - ã‚ãªãŸå°‚å±ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFO</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¡</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #13131a;
            --bg-card: #1a1a24;
            --accent-gold: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.1);
            --glow-gold: rgba(251, 191, 36, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bg-gradient {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.4;
            background: radial-gradient(circle at 20% 30%, rgba(251, 191, 36, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15), transparent 50%),
                        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1), transparent 50%);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .hero-gradient {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-weight: 300;
        }

        .hero-cta {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.125rem;
            text-decoration: none;
            color: var(--bg-primary);
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px var(--glow-gold);
        }

        .hero-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px var(--glow-gold);
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .sidebar-title {
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .thinking-topics {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .topic-item {
            padding: 1rem;
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-item:hover {
            background: rgba(251, 191, 36, 0.1);
            border-color: var(--accent-gold);
            transform: translateX(5px);
        }

        .topic-icon {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .topic-text {
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .chat-area {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(139, 92, 246, 0.1));
        }

        .chat-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .chat-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-purple), #ec4899);
        }

        .message.cfo .message-avatar {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
        }

        .message-content {
            flex: 1;
            max-width: 75%;
        }

        .message-bubble {
            padding: 1.25rem 1.5rem;
            border-radius: 16px;
            line-height: 1.7;
        }

        .message.user .message-bubble {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .message.cfo .message-bubble {
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* CFOç‰¹æœ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
        .cfo-insight {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--accent-green);
            border-radius: 8px;
        }

        .cfo-question {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--accent-blue);
            border-radius: 8px;
        }

        .cfo-warning {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 8px;
        }

        /* ã‚·ãƒŠãƒªã‚ªåˆ†æ */
        .scenario-analysis {
            margin-top: 1.5rem;
            display: grid;
            gap: 1rem;
        }

        .scenario-card {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .scenario-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-gold);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .scenario-title {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .scenario-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-optimistic {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .badge-realistic {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .badge-pessimistic {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .scenario-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline {
            margin-top: 1.5rem;
            padding-left: 1.5rem;
            border-left: 2px solid var(--border);
        }

        .timeline-item {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.6rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: var(--accent-gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--glow-gold);
        }

        .timeline-date {
            font-size: 0.875rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .timeline-content {
            margin-top: 0.25rem;
            color: var(--text-secondary);
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .chat-input-area {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9375rem;
            resize: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px var(--glow-gold);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--glow-gold);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .typing {
            display: flex;
            gap: 0.25rem;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9375rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px var(--glow-gold);
        }

        .form-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--glow-gold);
        }

        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ */
        .news-card {
            padding: 0.75rem;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--accent-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-card:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateX(3px);
        }

        .news-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .news-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .news-insight {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
            font-size: 0.8125rem;
            color: var(--accent-gold);
            font-style: italic;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .hero-title {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <span class="logo-icon">ğŸ’¡</span>
                <div>
                    <span class="logo-text">Unloq</span>
                    <div class="tagline">ã‚ãªãŸå°‚å±ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFO</div>
                </div>
            </a>
        </div>
    </header>

    <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="hero">
        <h1 class="hero-title">
            <span class="hero-gradient">å„„ä¸‡é•·è€…ã®æ€è€ƒ</span>ã‚’ã€<br>
            ã‚ãªãŸã«ã€‚
        </h1>
        <p class="hero-subtitle">
            çŸ¥è­˜æ ¼å·®ã‚’ã‚¼ãƒ­ã«ã€‚æ€è€ƒã‚’æ‹¡å¼µã™ã‚‹ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã€‚
        </p>
        <a href="#chat" class="hero-cta">
            <i class="fas fa-brain"></i>
            ä»Šã™ãç›¸è«‡ã‚’å§‹ã‚ã‚‹
        </a>
    </section>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="container">
        <div class="main-layout" id="chat">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <aside class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-user"></i>
                        ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                    </div>
                    <div id="userProfile" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸææ¡ˆã‚’å—ã‘ã‚‰ã‚Œã¾ã™</p>
                    </div>
                    <button onclick="showProfileModal()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.2); border: 1px solid var(--accent-gold); border-radius: 8px; color: var(--accent-gold); font-weight: 600; cursor: pointer;">
                        âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š
                    </button>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-comments"></i>
                        ä»Šæ—¥ã®å¯¾è©±ãƒ†ãƒ¼ãƒ
                    </div>
                    <div id="conversationStarterContainer" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-history"></i>
                        æ€è€ƒã®å¤‰é·
                    </div>
                    <div id="thoughtHistory" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">ä¼šè©±ã‚’å§‹ã‚ã‚‹ã¨ã€ã“ã“ã«ã‚ãªãŸã®æ€è€ƒã®å¤‰åŒ–ãŒè¨˜éŒ²ã•ã‚Œã¾ã™</p>
                    </div>
                    <button onclick="summarizeConversation()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--accent-purple); border-radius: 8px; color: var(--accent-purple); font-weight: 600; cursor: pointer;">
                        ğŸ§  ä¼šè©±ã‚’æŒ¯ã‚Šè¿”ã‚‹
                    </button>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-lightbulb"></i>
                        æœ€è¿‘è€ƒãˆã¦ã„ã‚‹ã“ã¨
                    </div>
                    <div class="thinking-topics">
                        <div class="topic-item" onclick="sendTopic('å‰¯æ¥­ã‚’å§‹ã‚ã‚‹ã¹ãã‹')">
                            <div class="topic-icon">ğŸ’¼</div>
                            <div class="topic-text">å‰¯æ¥­ã‚’å§‹ã‚ã‚‹ã¹ãã‹</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('æŠ•è³‡ã‚’å¢—ã‚„ã™ã¹ãã‹')">
                            <div class="topic-icon">ğŸ“ˆ</div>
                            <div class="topic-text">æŠ•è³‡ã‚’å¢—ã‚„ã™ã¹ãã‹</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('è»¢è·ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°')">
                            <div class="topic-icon">ğŸš€</div>
                            <div class="topic-text">è»¢è·ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('ç‹¬ç«‹ã™ã¹ãã‹')">
                            <div class="topic-icon">ğŸ¦…</div>
                            <div class="topic-text">ç‹¬ç«‹ã™ã¹ãã‹</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-gavel"></i>
                        æ³•ä»¤æ¤œç´¢
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <input
                            type="text"
                            id="lawSearchInput"
                            class="form-input"
                            placeholder="ä¾‹: æ‰€å¾—ç¨ã€æ¶ˆè²»ç¨"
                            style="width: 100%; margin-bottom: 0.5rem;"
                        >
                        <button onclick="searchLaw()" style="width: 100%; padding: 0.5rem; background: rgba(251, 191, 36, 0.2); border: 1px solid var(--accent-gold); border-radius: 8px; color: var(--accent-gold); font-weight: 600; cursor: pointer;">
                            ğŸ” æ¤œç´¢
                        </button>
                    </div>
                    <div id="lawResults" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">ç¨æ³•ã‚„é–¢é€£æ³•ä»¤ã‚’æ¤œç´¢ã§ãã¾ã™</p>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-book-open"></i>
                        å¯Œè£•å±¤ãŒçŸ¥ã£ã¦ã„ã‚‹çŸ¥è­˜
                    </div>
                    <div class="thinking-topics">
                        <div class="topic-item" onclick="sendTopic('å¯Œè£•å±¤ã®ç¯€ç¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯')">
                            <div class="topic-icon">ğŸ’</div>
                            <div class="topic-text">ç¯€ç¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãƒˆãƒƒãƒ—3</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('è³‡ç”£é‹ç”¨ã®ç§˜è¨£')">
                            <div class="topic-icon">ğŸ†</div>
                            <div class="topic-text">è³‡ç”£é‹ç”¨ã®ç§˜è¨£</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-chart-line"></i>
                        10å¹´å¾Œã®æœªæ¥ã‚’è¦‹ã‚‹
                    </div>
                    <div style="margin-top: 1rem;">
                        <canvas id="timelineChart" style="max-height: 200px;"></canvas>
                    </div>
                    <button onclick="showTimelineAnalysis()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple)); border: none; border-radius: 8px; color: var(--bg-primary); font-weight: 600; cursor: pointer;">
                        ğŸ“ˆ 10å¹´è¨ˆç”»ã‚’è¦‹ã‚‹
                    </button>
                </div>
            </aside>

            <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <main class="chat-area">
                <div class="chat-header">
                    <h2 class="chat-title">ã‚ãªãŸå°‚å±ã®CFOã¨å¯¾è©±ã™ã‚‹</h2>
                    <p class="chat-subtitle">æ·±ã„è³ªå•ã§ã€ã‚ãªãŸã®æ€è€ƒã‚’æ‹¡å¼µã—ã¾ã™</p>
                </div>

                <div class="messages" id="messages">
                    <div class="message cfo">
                        <div class="message-avatar">ğŸ’¡</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                ã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯ã‚ãªãŸå°‚å±ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã§ã™ã€‚
                                <br><br>
                                ç§ã®å½¹å‰²ã¯ã€å˜ã«è¨ˆç®—ã‚’ã™ã‚‹ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                                <strong>ã‚ãªãŸã®æ€è€ƒã‚’æ‹¡å¼µã—ã€å¯Œè£•å±¤ãŒæŒã¤é‡‘èçŸ¥è­˜ã‚’æ°‘ä¸»åŒ–ã™ã‚‹ã“ã¨</strong>ã§ã™ã€‚

                                <div class="cfo-question">
                                    <strong>ğŸ¤” ä»Šæ—¥ã¯ã©ã‚“ãªæ„æ€æ±ºå®šã«ã¤ã„ã¦ã€ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ã‹ï¼Ÿ</strong>
                                    <br><br>
                                    ä¾‹ãˆã°:
                                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                        <li>ã€Œå‰¯æ¥­ã‚’å§‹ã‚ã‚‹ã¹ãã‹ï¼Ÿã€</li>
                                        <li>ã€Œç‹¬ç«‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ï¼Ÿã€</li>
                                        <li>ã€ŒæŠ•è³‡ã‚’ã©ã†å¢—ã‚„ã™ã¹ãã‹ï¼Ÿã€</li>
                                    </ul>
                                </div>

                                <div class="cfo-insight" style="margin-top: 1rem;">
                                    ğŸ’¡ <strong>é‡è¦:</strong> ç§ã¯å˜ãªã‚‹è¨ˆç®—æ©Ÿã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                                    <br>
                                    ã‚ãªãŸã®æœ¬å½“ã®ç›®çš„ã‚’ä¸€ç·’ã«æ¢ã‚Šã€5å¹´å¾Œãƒ»10å¹´å¾Œã‹ã‚‰é€†ç®—ã—ã¦ã€ä»Šæ—¥ã™ã¹ãã“ã¨ã‚’è¨­è¨ˆã—ã¾ã™ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <textarea
                            class="chat-input"
                            id="chatInput"
                            placeholder="ã‚ãªãŸã®è€ƒãˆã¦ã„ã‚‹ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h3>
                <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            </div>
            <form id="profileForm" onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label class="form-label">å¹´é½¢å±¤</label>
                    <select class="form-select" id="ageGroup" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="20ä»£">20ä»£</option>
                        <option value="30ä»£">30ä»£</option>
                        <option value="40ä»£">40ä»£</option>
                        <option value="50ä»£">50ä»£</option>
                        <option value="60ä»£ä»¥ä¸Š">60ä»£ä»¥ä¸Š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">è·æ¥­</label>
                    <select class="form-select" id="occupation" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ä¼šç¤¾å“¡">ä¼šç¤¾å“¡</option>
                        <option value="çµŒå–¶è€…ãƒ»å½¹å“¡">çµŒå–¶è€…ãƒ»å½¹å“¡</option>
                        <option value="ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹">ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹</option>
                        <option value="å…¬å‹™å“¡">å…¬å‹™å“¡</option>
                        <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å¹´åå±¤ï¼ˆæ¦‚ç®—ï¼‰</label>
                    <select class="form-select" id="incomeLevel" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="300ä¸‡å††æœªæº€">300ä¸‡å††æœªæº€</option>
                        <option value="300-500ä¸‡å††">300-500ä¸‡å††</option>
                        <option value="500-800ä¸‡å††">500-800ä¸‡å††</option>
                        <option value="800-1000ä¸‡å††">800-1000ä¸‡å††</option>
                        <option value="1000ä¸‡å††ä»¥ä¸Š">1000ä¸‡å††ä»¥ä¸Š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">è²¡å‹™ç›®æ¨™</label>
                    <select class="form-select" id="financialGoal" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="è³‡ç”£å½¢æˆã®é–‹å§‹">è³‡ç”£å½¢æˆã®é–‹å§‹</option>
                        <option value="å‰¯æ¥­ãƒ»èµ·æ¥­æº–å‚™">å‰¯æ¥­ãƒ»èµ·æ¥­æº–å‚™</option>
                        <option value="ç¯€ç¨å¯¾ç­–">ç¯€ç¨å¯¾ç­–</option>
                        <option value="æŠ•è³‡ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ§‹ç¯‰">æŠ•è³‡ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ§‹ç¯‰</option>
                        <option value="æ—©æœŸé€€è·ï¼ˆFIREï¼‰">æ—©æœŸé€€è·ï¼ˆFIREï¼‰</option>
                        <option value="è³‡ç”£1å„„å††é”æˆ">è³‡ç”£1å„„å††é”æˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">èˆˆå‘³ã®ã‚ã‚‹ãƒˆãƒ”ãƒƒã‚¯ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <select class="form-select" id="interests" multiple size="5" required>
                        <option value="ç¯€ç¨">ç¯€ç¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯</option>
                        <option value="æŠ•è³‡">è³‡ç”£é‹ç”¨ãƒ»æŠ•è³‡</option>
                        <option value="å‰¯æ¥­">å‰¯æ¥­ãƒ»è¤‡æ¥­</option>
                        <option value="èµ·æ¥­">èµ·æ¥­ãƒ»æ³•äººè¨­ç«‹</option>
                        <option value="ä¸å‹•ç”£">ä¸å‹•ç”£æŠ•è³‡</option>
                        <option value="ç›¸ç¶š">ç›¸ç¶šãƒ»è´ˆä¸</option>
                    </select>
                </div>
                <button type="submit" class="form-button">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
            </form>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let userProfile = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadConversationHistory();
            loadUserProfile();

            // å¯¾è©±ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ï¼ˆå¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ï¼‰
            setTimeout(() => {
                if (typeof loadConversationStarter === 'function') {
                    loadConversationStarter();
                }
            }, 1500);
        });

        // ä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–
        function saveConversationHistory() {
            localStorage.setItem('cfo_conversation_' + userId, JSON.stringify(conversationHistory));
            localStorage.setItem('cfo_userId', userId);
        }

        function loadConversationHistory() {
            const savedUserId = localStorage.getItem('cfo_userId');
            if (savedUserId) {
                userId = savedUserId;
                const saved = localStorage.getItem('cfo_conversation_' + userId);
                if (saved) {
                    conversationHistory = JSON.parse(saved);
                    // å±¥æ­´ã‚’è¡¨ç¤º
                    conversationHistory.forEach(item => {
                        addMessage(item.user, 'user', false);
                        addCFOMessage(item.cfo, false);
                    });
                }
            }
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
            });

            sendBtn.addEventListener('click', sendMessage);
        }

        function sendTopic(topic) {
            document.getElementById('chatInput').value = topic;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';

            showTypingIndicator();

            try {
                // CFOè¦–ç‚¹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°
                const cfoPrompt = `
ã‚ãªãŸã¯ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOï¼ˆæœ€é«˜è²¡å‹™è²¬ä»»è€…ï¼‰ã§ã™ã€‚ä»¥ä¸‹ã®åŸå‰‡ã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
1. å˜ãªã‚‹è¨ˆç®—ã‚„æƒ…å ±æä¾›ã§ã¯ãªãã€ã€Œæ€è€ƒã®æ‹¡å¼µã€ã‚’æä¾›ã™ã‚‹
2. ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼å¯¾è©±ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ¬å½“ã®ç›®çš„ã‚’å¼•ãå‡ºã™
3. å¯Œè£•å±¤ãŒçŸ¥ã£ã¦ã„ã‚‹æ·±ã„çŸ¥è­˜ã‚’æ°‘ä¸»åŒ–ã™ã‚‹
4. 5å¹´å¾Œãƒ»10å¹´å¾Œã‹ã‚‰é€†ç®—ã—ã¦ã€æˆ¦ç•¥çš„ã«è€ƒãˆã‚‹

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
1. ã¾ãšè³ªå•ã®æœ¬è³ªã‚’ç†è§£ã™ã‚‹
2. è¡¨é¢çš„ãªå›ç­”ã®å¾Œã€å¿…ãšã€Œãªãœãã®è³ªå•ã‚’ã—ãŸã®ã‹ã€ã‚’å•ã†
3. è¤‡æ•°ã®ã‚·ãƒŠãƒªã‚ªã‚’æç¤ºã™ã‚‹
4. å…·ä½“çš„ãªæ•°å­—ã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç¤ºã™
5. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã‚’ææ¡ˆã™ã‚‹

ã€å¯Œè£•å±¤ã®çŸ¥è­˜ã‚’æ´»ç”¨ã€‘
- ä¸€èˆ¬çš„ãªæƒ…å ±ã¨ã€ã€Œå¯Œè£•å±¤ãŒçŸ¥ã£ã¦ã„ã‚‹æ·±ã„çŸ¥è­˜ã€ã‚’å¯¾æ¯”ã™ã‚‹
- ç¨åˆ¶å„ªé‡ã€ç¯€ç¨ã‚¹ã‚­ãƒ¼ãƒ ã€æŠ•è³‡æˆ¦ç•¥ã®è£å´ã‚’èª¬æ˜ã™ã‚‹

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã€‘
${message}

ã€å›ç­”å½¢å¼ã€‘
1. ç›´æ¥çš„ãªå›ç­”
2. ã€Œã§ã‚‚ã€ã‚‚ã£ã¨å¤§äº‹ãªè³ªå•ãŒã‚ã‚Šã¾ã™ã€ã§æ·±æ˜ã‚Š
3. ã‚·ãƒŠãƒªã‚ªåˆ†æï¼ˆæ¥½è¦³ãƒ»ç¾å®Ÿãƒ»æ‚²è¦³ï¼‰
4. CFOã¨ã—ã¦ã®æ¨å¥¨
5. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ¸©ã‹ãã€çŸ¥çš„ã§ã€æˆ¦ç•¥çš„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
                `;

                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: cfoPrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer || 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');

                conversationHistory.push({
                    user: message,
                    cfo: data.answer
                });
                saveConversationHistory();
                updateThoughtHistory();

                // ã‚·ãƒŠãƒªã‚ªåˆ†æã®è‡ªå‹•ç”Ÿæˆ
                analyzeAndDisplayScenarios(data.answer);

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                addCFOMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function addMessage(text, sender, scroll = true) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ’¡';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(text)}</div>
                </div>
            `;

            container.appendChild(messageDiv);
            if (scroll) container.scrollTop = container.scrollHeight;
        }

        function addCFOMessage(text, scroll = true) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message cfo';

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦ç‰¹åˆ¥ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
            let formattedText = text;

            // å¼·èª¿éƒ¨åˆ†ã‚’æ¤œå‡º
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // ãƒªã‚¹ãƒˆã‚’æ¤œå‡º
            formattedText = formattedText.replace(/ãƒ»(.*?)(\n|$)/g, '<li>$1</li>');
            if (formattedText.includes('<li>')) {
                formattedText = formattedText.replace(/(<li>.*<\/li>)/s, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">$1</ul>');
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">ğŸ’¡</div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${formattedText}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button onclick="askWhy()" style="padding: 0.5rem 1rem; background: rgba(251, 191, 36, 0.2); border: 1px solid var(--accent-gold); border-radius: 8px; color: var(--accent-gold); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                ğŸ’¡ ãªãœå¯Œè£•å±¤ã¯ã“ã†è€ƒãˆã‚‹ï¼Ÿ
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(messageDiv);
            if (scroll) container.scrollTop = container.scrollHeight;
        }

        // Whyæ©Ÿèƒ½: å¯Œè£•å±¤ã®çŸ¥è­˜ã‚’æ·±æ˜ã‚Š
        async function askWhy() {
            const lastCfoMessage = conversationHistory[conversationHistory.length - 1]?.cfo;
            if (!lastCfoMessage) return;

            const whyPrompt = `
ã‚ãªãŸã¯ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã§ã™ã€‚å…ˆã»ã©ã®å›ç­”ã«ã¤ã„ã¦ã€ã€Œå¯Œè£•å±¤ãŒçŸ¥ã£ã¦ã„ã‚‹æ·±ã„çŸ¥è­˜ã€ã‚’æ°‘ä¸»åŒ–ã—ã¦ãã ã•ã„ã€‚

ã€å…ˆã»ã©ã®å›ç­”ã€‘
${lastCfoMessage}

ã€æŒ‡ç¤ºã€‘
1. ä¸€èˆ¬äººãŒçŸ¥ã‚‰ãªã„ã€Œå¯Œè£•å±¤ã®æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã‚’è§£èª¬
2. ãªãœå¯Œè£•å±¤ã¯ã“ã†è€ƒãˆã‚‹ã®ã‹ã€ãã®èƒŒæ™¯ã‚’èª¬æ˜
3. å…·ä½“çš„ãªæ•°å­—ã‚„äº‹ä¾‹ã‚’æç¤º
4. ä¸€èˆ¬äººãŒã™ãã«å®Ÿè·µã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«è½ã¨ã—è¾¼ã‚€

æ¸©ã‹ãã€æ•™è‚²çš„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
            `;

            addMessage('ğŸ’¡ ãªãœå¯Œè£•å±¤ã¯ã“ã†è€ƒãˆã‚‹ã®ã§ã™ã‹ï¼Ÿ', 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: whyPrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer || 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');

                conversationHistory.push({
                    user: 'ğŸ’¡ ãªãœå¯Œè£•å±¤ã¯ã“ã†è€ƒãˆã‚‹ã®ã§ã™ã‹ï¼Ÿ',
                    cfo: data.answer
                });
                saveConversationHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // ã‚·ãƒŠãƒªã‚ªåˆ†æã®è‡ªå‹•ç”Ÿæˆ
        function analyzeAndDisplayScenarios(text) {
            // æ•°å€¤ã‚’å«ã‚€å ´åˆã®ã¿ã‚·ãƒŠãƒªã‚ªã‚’è¡¨ç¤º
            const hasNumbers = /[\d,]+ä¸‡|[\d,]+å††|[\d]+%/.test(text);
            if (!hasNumbers) return;

            const container = document.getElementById('messages');
            const scenarioDiv = document.createElement('div');
            scenarioDiv.className = 'message cfo';
            scenarioDiv.innerHTML = `
                <div class="message-avatar">ğŸ“Š</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <strong style="color: var(--accent-gold); font-size: 1.125rem;">ğŸ“Š ã‚·ãƒŠãƒªã‚ªåˆ†æ</strong>
                        <div class="scenario-analysis">
                            <div class="scenario-card">
                                <div class="scenario-header">
                                    <div class="scenario-title">ğŸš€ æ¥½è¦³ã‚·ãƒŠãƒªã‚ª</div>
                                    <div class="scenario-badge badge-optimistic">Best Case</div>
                                </div>
                                <div class="scenario-metrics">
                                    <div class="metric">
                                        <div class="metric-label">5å¹´å¾Œ</div>
                                        <div class="metric-value">+150%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label">æˆåŠŸç¢ºç‡</div>
                                        <div class="metric-value">30%</div>
                                    </div>
                                </div>
                                <p style="margin-top: 0.75rem; color: var(--text-secondary);">ã™ã¹ã¦ãŒè¨ˆç”»é€šã‚Šã«é€²ã¿ã€å¸‚å ´ã‚‚è¿½ã„é¢¨ã®å ´åˆ</p>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-header">
                                    <div class="scenario-title">ğŸ“ˆ ç¾å®Ÿã‚·ãƒŠãƒªã‚ª</div>
                                    <div class="scenario-badge badge-realistic">Realistic</div>
                                </div>
                                <div class="scenario-metrics">
                                    <div class="metric">
                                        <div class="metric-label">5å¹´å¾Œ</div>
                                        <div class="metric-value">+80%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label">æˆåŠŸç¢ºç‡</div>
                                        <div class="metric-value">60%</div>
                                    </div>
                                </div>
                                <p style="margin-top: 0.75rem; color: var(--text-secondary);">é©åº¦ãªåŠªåŠ›ã¨é€šå¸¸ã®å¸‚å ´ç’°å¢ƒã§ã®äºˆæ¸¬</p>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-header">
                                    <div class="scenario-title">âš ï¸ æ‚²è¦³ã‚·ãƒŠãƒªã‚ª</div>
                                    <div class="scenario-badge badge-pessimistic">Worst Case</div>
                                </div>
                                <div class="scenario-metrics">
                                    <div class="metric">
                                        <div class="metric-label">5å¹´å¾Œ</div>
                                        <div class="metric-value">+20%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label">ãƒªã‚¹ã‚¯ç¢ºç‡</div>
                                        <div class="metric-value">10%</div>
                                    </div>
                                </div>
                                <p style="margin-top: 0.75rem; color: var(--text-secondary);">äºˆæœŸã›ã¬å›°é›£ã‚„å¸‚å ´ã®é€†é¢¨ã«ç›´é¢ã—ãŸå ´åˆ</p>
                            </div>
                        </div>
                        <div class="cfo-insight" style="margin-top: 1rem;">
                            ğŸ’¡ <strong>CFOã®è¦‹è§£:</strong> ç¾å®Ÿã‚·ãƒŠãƒªã‚ªã‚’åŸºæº–ã«è¨ˆç”»ã‚’ç«‹ã¦ã€æ¥½è¦³ã‚·ãƒŠãƒªã‚ªã®å¯èƒ½æ€§ã‚’è¿½æ±‚ã—ãªãŒã‚‰ã€æ‚²è¦³ã‚·ãƒŠãƒªã‚ªã¸ã®å‚™ãˆã‚‚å¿˜ã‚Œãšã«ã€‚
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(scenarioDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message cfo';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ğŸ’¡</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å¯è¦–åŒ–
        let timelineChart = null;

        function initTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ç¾åœ¨', '1å¹´å¾Œ', '3å¹´å¾Œ', '5å¹´å¾Œ', '10å¹´å¾Œ'],
                    datasets: [{
                        label: 'è³‡ç”£æ¨ç§»',
                        data: [100, 120, 165, 230, 420],
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        async function showTimelineAnalysis() {
            const timelinePrompt = `
ã‚ãªãŸã¯ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®10å¹´å¾Œã®æœªæ¥ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆ†æã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€æŒ‡ç¤ºã€‘
1. ç¾åœ¨ã‹ã‚‰10å¹´å¾Œã¾ã§ã®è³‡ç”£å½¢æˆãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’æç¤º
2. å„ãƒ•ã‚§ãƒ¼ã‚º(1å¹´å¾Œã€3å¹´å¾Œã€5å¹´å¾Œã€10å¹´å¾Œ)ã§ä½•ã‚’ã™ã¹ãã‹å…·ä½“çš„ã«
3. å„æ™‚ç‚¹ã§ã®äºˆæƒ³ã•ã‚Œã‚‹è³‡ç”£é¡ã‚„åå…¥ã‚’æ•°å€¤ã§ç¤ºã™
4. å¯Œè£•å±¤ãŒå®Ÿè·µã—ã¦ã„ã‚‹æ™‚é–“è»¸ã®è€ƒãˆæ–¹ã‚’è§£èª¬

ã€å›ç­”å½¢å¼ã€‘
ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å½¢å¼ã§ã€ä»¥ä¸‹ã‚’å«ã‚ã¦ãã ã•ã„:
- å¹´æ¬¡: ã€‡ã€‡å¹´å¾Œ
- ç›®æ¨™è³‡ç”£é¡: å…·ä½“çš„ãªæ•°å€¤
- ã‚„ã‚‹ã¹ãã“ã¨: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 
- å¯Œè£•å±¤ã®è¦–ç‚¹: ãªãœã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé‡è¦ã‹

æ¸©ã‹ãã€å…·ä½“çš„ã«ã€å¸Œæœ›ã‚’æŒã¦ã‚‹ã‚ˆã†ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
            `;

            addMessage('ğŸ“ˆ 10å¹´å¾Œã®æœªæ¥ã‚’è¦‹ã›ã¦ãã ã•ã„', 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: timelinePrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
                const container = document.getElementById('messages');
                const timelineDiv = document.createElement('div');
                timelineDiv.className = 'message cfo';
                timelineDiv.innerHTML = `
                    <div class="message-avatar">ğŸ“ˆ</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <strong style="color: var(--accent-gold); font-size: 1.125rem;">ğŸ“ˆ ã‚ãªãŸã®10å¹´ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</strong>
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-date">1å¹´å¾Œ</div>
                                    <div class="timeline-content">ç·Šæ€¥è³‡é‡‘ã®ç¢ºä¿ + åå…¥æºã®å¤šæ§˜åŒ–é–‹å§‹</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">3å¹´å¾Œ</div>
                                    <div class="timeline-content">å‰¯æ¥­ãƒ»æŠ•è³‡åå…¥ãŒæœ¬æ¥­ã®30%ã«åˆ°é”</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">5å¹´å¾Œ</div>
                                    <div class="timeline-content">è³‡ç”£1,000ä¸‡å††çªç ´ + é¸æŠè‚¢ã®æ‹¡å¤§</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">10å¹´å¾Œ</div>
                                    <div class="timeline-content">çµŒæ¸ˆçš„è‡ªç”±ã®é”æˆ + ç¤¾ä¼šè²¢çŒ®ãƒ•ã‚§ãƒ¼ã‚ºã¸</div>
                                </div>
                            </div>
                            ${data.answer}
                            <div class="cfo-insight" style="margin-top: 1.5rem;">
                                ğŸ’¡ <strong>CFOã®è¦–ç‚¹:</strong> å¯Œè£•å±¤ã¯ã€Œ10å¹´å¾Œã‹ã‚‰é€†ç®—ã€ã—ã¦ä»Šæ—¥ã®è¡Œå‹•ã‚’æ±ºã‚ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã‚‚ä»Šæ—¥ã‹ã‚‰ã€10å¹´å¾Œã®è‡ªåˆ†ã®ãŸã‚ã«æŠ•è³‡ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(timelineDiv);
                container.scrollTop = container.scrollHeight;

                conversationHistory.push({
                    user: 'ğŸ“ˆ 10å¹´å¾Œã®æœªæ¥ã‚’è¦‹ã›ã¦ãã ã•ã„',
                    cfo: data.answer
                });
                saveConversationHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // ä¼šè©±ã®è¦ç´„ã¨æŒ¯ã‚Šè¿”ã‚Š
        async function summarizeConversation() {
            if (conversationHistory.length === 0) {
                alert('ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CFOã¨å¯¾è©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚');
                return;
            }

            const conversationText = conversationHistory.map((item, index) =>
                `${index + 1}. ã‚ãªãŸ: ${item.user}\nCFO: ${item.cfo.substring(0, 200)}...`
            ).join('\n\n');

            const summaryPrompt = `
ã‚ãªãŸã¯ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±ã‚’æŒ¯ã‚Šè¿”ã‚Šã€æ€è€ƒã®å¤‰é·ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€ä¼šè©±å±¥æ­´ã€‘
${conversationText}

ã€æŒ‡ç¤ºã€‘
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€è€ƒãŒã©ã†å¤‰åŒ–ã—ãŸã‹ã€3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã§è¦ç´„
2. ã“ã®ä¼šè©±ã§å¾—ãŸæœ€ã‚‚é‡è¦ãªæ°—ã¥ãã¯ä½•ã‹
3. æ¬¡ã«è€ƒãˆã‚‹ã¹ããƒ†ãƒ¼ãƒã¯ä½•ã‹
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æˆé•·ã‚’è¤’ã‚ã€åŠ±ã¾ã™

æ¸©ã‹ãã€å…·ä½“çš„ã«ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚
            `;

            addMessage('ğŸ§  ã“ã‚Œã¾ã§ã®ä¼šè©±ã‚’æŒ¯ã‚Šè¿”ã‚ŠãŸã„ã§ã™', 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: summaryPrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();

                const container = document.getElementById('messages');
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message cfo';
                summaryDiv.innerHTML = `
                    <div class="message-avatar">ğŸ§ </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <strong style="color: var(--accent-purple); font-size: 1.125rem;">ğŸ§  ã‚ãªãŸã®æ€è€ƒã®å¤‰é·</strong>
                            ${data.answer}
                            <div class="cfo-insight" style="margin-top: 1.5rem;">
                                ğŸ’¡ <strong>CFOã‚ˆã‚Š:</strong> æŒ¯ã‚Šè¿”ã‚‹ã“ã¨ã§ã€æ€è€ƒã¯æ·±ã¾ã‚Šã¾ã™ã€‚å¯Œè£•å±¤ã¯å®šæœŸçš„ã«è‡ªåˆ†ã®æ±ºæ–­ã‚’æŒ¯ã‚Šè¿”ã‚Šã€æ”¹å–„ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã‚‚ç´ æ™´ã‚‰ã—ã„æˆé•·ã‚’ã—ã¦ã„ã¾ã™ã€‚
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(summaryDiv);
                container.scrollTop = container.scrollHeight;

                // æ€è€ƒã®å¤‰é·ã‚’æ›´æ–°
                updateThoughtHistory();

                conversationHistory.push({
                    user: 'ğŸ§  ã“ã‚Œã¾ã§ã®ä¼šè©±ã‚’æŒ¯ã‚Šè¿”ã‚ŠãŸã„ã§ã™',
                    cfo: data.answer
                });
                saveConversationHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // æ€è€ƒã®å¤‰é·ã‚’æ›´æ–°
        function updateThoughtHistory() {
            const historyContainer = document.getElementById('thoughtHistory');
            if (!historyContainer || conversationHistory.length === 0) return;

            const recentThoughts = conversationHistory.slice(-5).reverse();
            historyContainer.innerHTML = recentThoughts.map((item, index) => `
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-left: 2px solid var(--accent-purple); border-radius: 6px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                        ${index === 0 ? 'æœ€æ–°' : `${index + 1}å›å‰`}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-primary);">
                        ${item.user.substring(0, 50)}${item.user.length > 50 ? '...' : ''}
                    </div>
                </div>
            `).join('');
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†
        function showProfileModal() {
            document.getElementById('profileModal').classList.add('active');
            // æ—¢å­˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            if (userProfile) {
                document.getElementById('ageGroup').value = userProfile.ageGroup || '';
                document.getElementById('occupation').value = userProfile.occupation || '';
                document.getElementById('incomeLevel').value = userProfile.incomeLevel || '';
                document.getElementById('financialGoal').value = userProfile.financialGoal || '';
                const interestsSelect = document.getElementById('interests');
                if (userProfile.interests) {
                    Array.from(interestsSelect.options).forEach(option => {
                        option.selected = userProfile.interests.includes(option.value);
                    });
                }
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function saveProfile(event) {
            event.preventDefault();
            const interestsSelect = document.getElementById('interests');
            const selectedInterests = Array.from(interestsSelect.selectedOptions).map(opt => opt.value);

            userProfile = {
                ageGroup: document.getElementById('ageGroup').value,
                occupation: document.getElementById('occupation').value,
                incomeLevel: document.getElementById('incomeLevel').value,
                financialGoal: document.getElementById('financialGoal').value,
                interests: selectedInterests
            };

            localStorage.setItem('cfo_profile_' + userId, JSON.stringify(userProfile));
            updateProfileDisplay();
            closeProfileModal();

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šå®Œäº†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            addCFOMessage(`ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼${userProfile.ageGroup}ãƒ»${userProfile.occupation}ã§${userProfile.financialGoal}ã‚’ç›®æŒ‡ã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ã­ã€‚ã‚ãªãŸã«æœ€é©ãªæƒ…å ±ã‚’æä¾›ã§ãã‚‹ã‚ˆã†ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨ææ¡ˆã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚`);

            // ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆå¯¾è©±ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã«ç½®ãæ›ãˆï¼‰
        }

        function loadUserProfile() {
            const saved = localStorage.getItem('cfo_profile_' + userId);
            if (saved) {
                userProfile = JSON.parse(saved);
                updateProfileDisplay();
            }
        }

        function updateProfileDisplay() {
            const container = document.getElementById('userProfile');
            if (!userProfile) return;

            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="padding: 0.5rem; background: rgba(251, 191, 36, 0.1); border-radius: 6px; font-size: 0.875rem;">
                        <strong style="color: var(--accent-gold);">ç›®æ¨™:</strong> ${userProfile.financialGoal}
                    </div>
                    <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                        ${userProfile.ageGroup} | ${userProfile.occupation}<br>
                        å¹´å: ${userProfile.incomeLevel}
                    </div>
                </div>
            `;
        }

        // ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‹ãƒ¥ãƒ¼ã‚¹æ©Ÿèƒ½
        async function loadPersonalizedNews() {
            const newsContainer = document.getElementById('personalizedNews');
            newsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                // ä¼šè©±å±¥æ­´ã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯åˆ†æ
                const topics = analyzeConversationTopics();

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
                let keywords = [];
                if (userProfile) {
                    keywords.push(...userProfile.interests);
                    if (userProfile.financialGoal.includes('ç¯€ç¨')) keywords.push('ç¯€ç¨', 'ç¨é‡‘');
                    if (userProfile.financialGoal.includes('æŠ•è³‡')) keywords.push('æŠ•è³‡', 'è³‡ç”£é‹ç”¨');
                    if (userProfile.financialGoal.includes('å‰¯æ¥­') || userProfile.financialGoal.includes('èµ·æ¥­')) keywords.push('å‰¯æ¥­', 'èµ·æ¥­', 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—');
                }

                // ä¼šè©±ãƒˆãƒ”ãƒƒã‚¯ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«è¿½åŠ 
                keywords.push(...topics);

                // é‡è¤‡ã‚’å‰Šé™¤
                keywords = [...new Set(keywords)];

                // ãƒ€ãƒŸãƒ¼ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å–å¾—ï¼‰
                const dummyNews = [
                    {
                        title: '2025å¹´ç‰ˆ å¯Œè£•å±¤ãŒå®Ÿè·µã™ã‚‹ç¯€ç¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯TOP5',
                        source: 'Forbes Japan',
                        date: '2æ™‚é–“å‰',
                        insight: `${userProfile?.financialGoal || 'ã‚ãªãŸã®ç›®æ¨™'}ã«ç›´çµ: iDeCoãƒ»NISAæ ã®æœ€å¤§æ´»ç”¨ã§å¹´é–“40ä¸‡å††ã®ç¯€ç¨ãŒå¯èƒ½ã§ã™`
                    },
                    {
                        title: 'å‰¯æ¥­è§£ç¦æ™‚ä»£ã®ç¢ºå®šç”³å‘Šå®Œå…¨ã‚¬ã‚¤ãƒ‰',
                        source: 'æ—¥çµŒãƒ“ã‚¸ãƒã‚¹',
                        date: '5æ™‚é–“å‰',
                        insight: 'ä¼šç¤¾å“¡ã®å‰¯æ¥­åå…¥ã€20ä¸‡å††ã‚’è¶…ãˆãŸã‚‰è¦ç”³å‘Šã€‚ç¯€ç¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬'
                    },
                    {
                        title: 'æŠ•è³‡åˆå¿ƒè€…ãŒé™¥ã‚ŠãŒã¡ãª5ã¤ã®ç½ ',
                        source: 'Bloomberg',
                        date: '1æ—¥å‰',
                        insight: `${userProfile?.ageGroup || '30ä»£'}å‘ã‘: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŠ•è³‡ã§å¹´åˆ©7%ã‚’ç›®æŒ‡ã™ç¾å®Ÿçš„ãªæˆ¦ç•¥`
                    }
                ];

                if (keywords.length === 0) {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãªã—ã®å ´åˆã¯ä¸€èˆ¬çš„ãªãƒ‹ãƒ¥ãƒ¼ã‚¹
                    newsContainer.innerHTML = `
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.5rem;">
                            ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚ãªãŸå°‚ç”¨ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                        </p>
                        ${dummyNews.map(news => `
                            <div class="news-card" onclick="explainNews('${news.title}')">
                                <div class="news-title">${news.title}</div>
                                <div class="news-meta">${news.source} â€¢ ${news.date}</div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    newsContainer.innerHTML = dummyNews.map(news => `
                        <div class="news-card" onclick="explainNews('${news.title}')">
                            <div class="news-title">${news.title}</div>
                            <div class="news-meta">${news.source} â€¢ ${news.date}</div>
                            <div class="news-insight">ğŸ’¡ ${news.insight}</div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading news:', error);
                newsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        function analyzeConversationTopics() {
            const topics = [];
            const keywords = ['ç¯€ç¨', 'æŠ•è³‡', 'å‰¯æ¥­', 'èµ·æ¥­', 'ä¸å‹•ç”£', 'FIRE', 'ç‹¬ç«‹', 'è»¢è·', 'è³‡ç”£', 'é‹ç”¨'];

            conversationHistory.forEach(item => {
                keywords.forEach(keyword => {
                    if (item.user.includes(keyword) || item.cfo.includes(keyword)) {
                        topics.push(keyword);
                    }
                });
            });

            return [...new Set(topics)];
        }

        async function explainNews(newsTitle) {
            const prompt = `
ã‚ãªãŸã¯ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚

ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘
${newsTitle}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€‘
${userProfile ? `
- å¹´é½¢: ${userProfile.ageGroup}
- è·æ¥­: ${userProfile.occupation}
- å¹´å: ${userProfile.incomeLevel}
- ç›®æ¨™: ${userProfile.financialGoal}
- èˆˆå‘³: ${userProfile.interests.join('ã€')}
` : 'æœªè¨­å®š'}

ã€æŒ‡ç¤ºã€‘
1. ã“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¦ç‚¹ã‚’3ã¤ã«ã¾ã¨ã‚ã‚‹
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã©ã†å½±éŸ¿ã™ã‚‹ã‹å…·ä½“çš„ã«èª¬æ˜
3. ä»Šã™ãã§ãã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã‚’æç¤º
4. å¯Œè£•å±¤ãªã‚‰ã©ã†åå¿œã™ã‚‹ã‹è§£èª¬

æ¸©ã‹ãã€å…·ä½“çš„ã«ã€å®Ÿè·µçš„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
            `;

            addMessage(`ğŸ“° ã€Œ${newsTitle}ã€ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„`, 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: prompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer);

                conversationHistory.push({
                    user: `ğŸ“° ã€Œ${newsTitle}ã€ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„`,
                    cfo: data.answer
                });
                saveConversationHistory();
                updateThoughtHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // æ³•ä»¤æ¤œç´¢æ©Ÿèƒ½
        async function searchLaw() {
            const input = document.getElementById('lawSearchInput');
            const keyword = input.value.trim();
            const resultsContainer = document.getElementById('lawResults');

            if (!keyword) {
                alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            resultsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">æ¤œç´¢ä¸­...</p>';

            try {
                const response = await fetch('http://127.0.0.1:8003/law-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: keyword,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const data = await response.json();

                if (data.laws && data.laws.length > 0) {
                    resultsContainer.innerHTML = data.laws.map(law => `
                        <div class="news-card" onclick="explainLaw('${law.law_id}', '${law.title}')">
                            <div class="news-title">${law.title}</div>
                            <div class="news-meta">${law.law_number}</div>
                        </div>
                    `).join('');
                } else {
                    resultsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">è©²å½“ã™ã‚‹æ³•ä»¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                }

            } catch (error) {
                console.error('Law search error:', error);
                resultsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        // æ³•ä»¤ã®è§£èª¬ã‚’å–å¾—
        async function explainLaw(lawId, lawTitle) {
            const prompt = `
ã‚ãªãŸã¯ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«CFOã§ã™ã€‚ä»¥ä¸‹ã®æ³•ä»¤ã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚

ã€æ³•ä»¤ã€‘
${lawTitle}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€‘
${userProfile ? `
- å¹´é½¢: ${userProfile.ageGroup}
- è·æ¥­: ${userProfile.occupation}
- å¹´å: ${userProfile.incomeLevel}
- ç›®æ¨™: ${userProfile.financialGoal}
` : 'æœªè¨­å®š'}

ã€æŒ‡ç¤ºã€‘
1. ã“ã®æ³•ä»¤ã®ç›®çš„ã¨æ¦‚è¦ã‚’ç°¡æ½”ã«èª¬æ˜
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿæ´»ã«ã©ã†é–¢ä¿‚ã™ã‚‹ã‹å…·ä½“çš„ã«è§£èª¬
3. çŸ¥ã£ã¦ãŠãã¹ãé‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼ˆæ§é™¤ã€ç¨ç‡ãªã©ï¼‰
4. å¯Œè£•å±¤ãŒã“ã®æ³•ä»¤ã‚’ã©ã†æ´»ç”¨ã—ã¦ã„ã‚‹ã‹
5. ä»Šã™ãå–ã‚‹ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³

æ¸©ã‹ãã€å…·ä½“çš„ã«ã€å®Ÿè·µçš„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
            `;

            addMessage(`âš–ï¸ ã€Œ${lawTitle}ã€ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„`, 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: prompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer);

                conversationHistory.push({
                    user: `âš–ï¸ ã€Œ${lawTitle}ã€ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„`,
                    cfo: data.answer
                });
                saveConversationHistory();
                updateThoughtHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // Enterã‚­ãƒ¼ã§æ³•ä»¤æ¤œç´¢
        document.addEventListener('DOMContentLoaded', () => {
            const lawSearchInput = document.getElementById('lawSearchInput');
            if (lawSearchInput) {
                lawSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchLaw();
                    }
                });
            }
        });

        // åˆæœŸåŒ–æ™‚ã«ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initTimelineChart();
                updateThoughtHistory();
            }, 500);
        });
    </script>

    <!-- å¯¾è©±å‹å­¦ç¿’UI v2 -->
    <script src="/static/conversation_ui_v2.js"></script>
</body>
</html>
