<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unloq - „ÅÇ„Å™„ÅüÂ∞ÇÂ±û„ÅÆ„Éë„Éº„ÇΩ„Éä„É´CFO</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí°</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #13131a;
            --bg-card: #1a1a24;
            --accent-gold: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.1);
            --glow-gold: rgba(251, 191, 36, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
        .bg-gradient {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.4;
            background: radial-gradient(circle at 20% 30%, rgba(251, 191, 36, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15), transparent 50%),
                        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1), transparent 50%);
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* „Éí„Éº„É≠„Éº„Çª„ÇØ„Ç∑„Éß„É≥ */
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .hero-gradient {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-weight: 300;
        }

        .hero-cta {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.125rem;
            text-decoration: none;
            color: var(--bg-primary);
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px var(--glow-gold);
        }

        .hero-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px var(--glow-gold);
        }

        /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        /* „Çµ„Ç§„Éâ„Éê„Éº */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .sidebar-title {
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .thinking-topics {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .topic-item {
            padding: 1rem;
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-item:hover {
            background: rgba(251, 191, 36, 0.1);
            border-color: var(--accent-gold);
            transform: translateX(5px);
        }

        .topic-icon {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .topic-text {
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ */
        .chat-area {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(139, 92, 246, 0.1));
        }

        .chat-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .chat-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-purple), #ec4899);
        }

        .message.cfo .message-avatar {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
        }

        .message-content {
            flex: 1;
            max-width: 75%;
        }

        .message-bubble {
            padding: 1.25rem 1.5rem;
            border-radius: 16px;
            line-height: 1.7;
        }

        .message.user .message-bubble {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .message.cfo .message-bubble {
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* CFOÁâπÊúâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çπ„Çø„Ç§„É´ */
        .cfo-insight {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--accent-green);
            border-radius: 8px;
        }

        .cfo-question {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--accent-blue);
            border-radius: 8px;
        }

        .cfo-warning {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            border-radius: 8px;
        }

        /* „Ç∑„Éä„É™„Ç™ÂàÜÊûê */
        .scenario-analysis {
            margin-top: 1.5rem;
            display: grid;
            gap: 1rem;
        }

        .scenario-card {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .scenario-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-gold);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .scenario-title {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .scenario-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-optimistic {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .badge-realistic {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .badge-pessimistic {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .scenario-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .metric {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* „Çø„Ç§„É†„É©„Ç§„É≥ */
        .timeline {
            margin-top: 1.5rem;
            padding-left: 1.5rem;
            border-left: 2px solid var(--border);
        }

        .timeline-item {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.6rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: var(--accent-gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--glow-gold);
        }

        .timeline-date {
            font-size: 0.875rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .timeline-content {
            margin-top: 0.25rem;
            color: var(--text-secondary);
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        .chat-input-area {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9375rem;
            resize: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px var(--glow-gold);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--glow-gold);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .typing {
            display: flex;
            gap: 0.25rem;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9375rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px var(--glow-gold);
        }

        .form-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--glow-gold);
        }

        /* „Éã„É•„Éº„Çπ„Ç´„Éº„Éâ */
        .news-card {
            padding: 0.75rem;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--accent-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-card:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateX(3px);
        }

        .news-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .news-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .news-insight {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
            font-size: 0.8125rem;
            color: var(--accent-gold);
            font-style: italic;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .hero-title {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <span class="logo-icon">üí°</span>
                <div>
                    <span class="logo-text">Unloq</span>
                    <div class="tagline">„ÅÇ„Å™„ÅüÂ∞ÇÂ±û„ÅÆ„Éë„Éº„ÇΩ„Éä„É´CFO</div>
                </div>
            </a>
        </div>
    </header>

    <!-- „Éí„Éº„É≠„Éº„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <section class="hero">
        <h1 class="hero-title">
            <span class="hero-gradient">ÂÑÑ‰∏áÈï∑ËÄÖ„ÅÆÊÄùËÄÉ</span>„Çí„ÄÅ<br>
            „ÅÇ„Å™„Åü„Å´„ÄÇ
        </h1>
        <p class="hero-subtitle">
            Áü•Ë≠òÊ†ºÂ∑Æ„Çí„Çº„É≠„Å´„ÄÇÊÄùËÄÉ„ÇíÊã°Âºµ„Åô„Çã„ÄÅ„Éë„Éº„ÇΩ„Éä„É´CFO„ÄÇ
        </p>
        <a href="#chat" class="hero-cta">
            <i class="fas fa-brain"></i>
            ‰ªä„Åô„ÅêÁõ∏Ë´á„ÇíÂßã„ÇÅ„Çã
        </a>
    </section>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="container">
        <div class="main-layout" id="chat">
            <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
            <aside class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-user"></i>
                        „ÅÇ„Å™„Åü„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´
                    </div>
                    <div id="userProfile" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">„Éó„É≠„Éï„Ç£„Éº„É´„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅ„Çà„Çä„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Åï„Çå„ÅüÊèêÊ°à„ÇíÂèó„Åë„Çâ„Çå„Åæ„Åô</p>
                    </div>
                    <button onclick="showProfileModal()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.2); border: 1px solid var(--accent-gold); border-radius: 8px; color: var(--accent-gold); font-weight: 600; cursor: pointer;">
                        ‚öôÔ∏è „Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö
                    </button>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-comments"></i>
                        ‰ªäÊó•„ÅÆÂØæË©±„ÉÜ„Éº„Éû
                    </div>
                    <div id="conversationStarterContainer" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-history"></i>
                        ÊÄùËÄÉ„ÅÆÂ§âÈÅ∑
                    </div>
                    <div id="thoughtHistory" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">‰ºöË©±„ÇíÂßã„ÇÅ„Çã„Å®„ÄÅ„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆÊÄùËÄÉ„ÅÆÂ§âÂåñ„ÅåË®òÈå≤„Åï„Çå„Åæ„Åô</p>
                    </div>
                    <button onclick="summarizeConversation()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--accent-purple); border-radius: 8px; color: var(--accent-purple); font-weight: 600; cursor: pointer;">
                        üß† ‰ºöË©±„ÇíÊåØ„ÇäËøî„Çã
                    </button>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-lightbulb"></i>
                        ÊúÄËøëËÄÉ„Åà„Å¶„ÅÑ„Çã„Åì„Å®
                    </div>
                    <div class="thinking-topics">
                        <div class="topic-item" onclick="sendTopic('ÂâØÊ•≠„ÇíÂßã„ÇÅ„Çã„Åπ„Åç„Åã')">
                            <div class="topic-icon">üíº</div>
                            <div class="topic-text">ÂâØÊ•≠„ÇíÂßã„ÇÅ„Çã„Åπ„Åç„Åã</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('ÊäïË≥á„ÇíÂ¢ó„ÇÑ„Åô„Åπ„Åç„Åã')">
                            <div class="topic-icon">üìà</div>
                            <div class="topic-text">ÊäïË≥á„ÇíÂ¢ó„ÇÑ„Åô„Åπ„Åç„Åã</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('Ëª¢ËÅ∑„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞')">
                            <div class="topic-icon">üöÄ</div>
                            <div class="topic-text">Ëª¢ËÅ∑„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('Áã¨Á´ã„Åô„Åπ„Åç„Åã')">
                            <div class="topic-icon">ü¶Ö</div>
                            <div class="topic-text">Áã¨Á´ã„Åô„Åπ„Åç„Åã</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-gavel"></i>
                        Ê≥ï‰ª§Ê§úÁ¥¢
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <input
                            type="text"
                            id="lawSearchInput"
                            class="form-input"
                            placeholder="‰æã: ÊâÄÂæóÁ®é„ÄÅÊ∂àË≤ªÁ®é"
                            style="width: 100%; margin-bottom: 0.5rem;"
                        >
                        <button onclick="searchLaw()" style="width: 100%; padding: 0.5rem; background: rgba(251, 191, 36, 0.2); border: 1px solid var(--accent-gold); border-radius: 8px; color: var(--accent-gold); font-weight: 600; cursor: pointer;">
                            üîç Ê§úÁ¥¢
                        </button>
                    </div>
                    <div id="lawResults" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Á®éÊ≥ï„ÇÑÈñ¢ÈÄ£Ê≥ï‰ª§„ÇíÊ§úÁ¥¢„Åß„Åç„Åæ„Åô</p>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-book-open"></i>
                        ÂØåË£ïÂ±§„ÅåÁü•„Å£„Å¶„ÅÑ„ÇãÁü•Ë≠ò
                    </div>
                    <div class="thinking-topics">
                        <div class="topic-item" onclick="sendTopic('ÂØåË£ïÂ±§„ÅÆÁØÄÁ®é„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ')">
                            <div class="topic-icon">üíé</div>
                            <div class="topic-text">ÁØÄÁ®é„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ„Éà„ÉÉ„Éó3</div>
                        </div>
                        <div class="topic-item" onclick="sendTopic('Ë≥áÁî£ÈÅãÁî®„ÅÆÁßòË®£')">
                            <div class="topic-icon">üèÜ</div>
                            <div class="topic-text">Ë≥áÁî£ÈÅãÁî®„ÅÆÁßòË®£</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-chart-line"></i>
                        10Âπ¥Âæå„ÅÆÊú™Êù•„ÇíË¶ã„Çã
                    </div>
                    <div style="margin-top: 1rem;">
                        <canvas id="timelineChart" style="max-height: 200px;"></canvas>
                    </div>
                    <button onclick="showTimelineAnalysis()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple)); border: none; border-radius: 8px; color: var(--bg-primary); font-weight: 600; cursor: pointer;">
                        üìà 10Âπ¥Ë®àÁîª„ÇíË¶ã„Çã
                    </button>
                </div>
            </aside>

            <!-- „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
            <main class="chat-area">
                <div class="chat-header">
                    <h2 class="chat-title">„ÅÇ„Å™„ÅüÂ∞ÇÂ±û„ÅÆCFO„Å®ÂØæË©±„Åô„Çã</h2>
                    <p class="chat-subtitle">Ê∑±„ÅÑË≥™Âïè„Åß„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊÄùËÄÉ„ÇíÊã°Âºµ„Åó„Åæ„Åô</p>
                </div>

                <div class="messages" id="messages">
                    <div class="message cfo">
                        <div class="message-avatar">üí°</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                „Åì„Çì„Å´„Å°„ÅØ„ÄÇÁßÅ„ÅØ„ÅÇ„Å™„ÅüÂ∞ÇÂ±û„ÅÆ„Éë„Éº„ÇΩ„Éä„É´CFO„Åß„Åô„ÄÇ
                                <br><br>
                                ÁßÅ„ÅÆÂΩπÂâ≤„ÅØ„ÄÅÂçò„Å´Ë®àÁÆó„Çí„Åô„Çã„Åì„Å®„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                                <strong>„ÅÇ„Å™„Åü„ÅÆÊÄùËÄÉ„ÇíÊã°Âºµ„Åó„ÄÅÂØåË£ïÂ±§„ÅåÊåÅ„Å§ÈáëËûçÁü•Ë≠ò„ÇíÊ∞ë‰∏ªÂåñ„Åô„Çã„Åì„Å®</strong>„Åß„Åô„ÄÇ

                                <div class="cfo-question">
                                    <strong>ü§î ‰ªäÊó•„ÅØ„Å©„Çì„Å™ÊÑèÊÄùÊ±∫ÂÆö„Å´„Å§„ÅÑ„Å¶„ÄÅ‰∏ÄÁ∑í„Å´ËÄÉ„Åà„Åæ„Åó„Çá„ÅÜ„ÅãÔºü</strong>
                                    <br><br>
                                    ‰æã„Åà„Å∞:
                                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                        <li>„ÄåÂâØÊ•≠„ÇíÂßã„ÇÅ„Çã„Åπ„Åç„ÅãÔºü„Äç</li>
                                        <li>„ÄåÁã¨Á´ã„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅØÔºü„Äç</li>
                                        <li>„ÄåÊäïË≥á„Çí„Å©„ÅÜÂ¢ó„ÇÑ„Åô„Åπ„Åç„ÅãÔºü„Äç</li>
                                    </ul>
                                </div>

                                <div class="cfo-insight" style="margin-top: 1rem;">
                                    üí° <strong>ÈáçË¶Å:</strong> ÁßÅ„ÅØÂçò„Å™„ÇãË®àÁÆóÊ©ü„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                                    <br>
                                    „ÅÇ„Å™„Åü„ÅÆÊú¨ÂΩì„ÅÆÁõÆÁöÑ„Çí‰∏ÄÁ∑í„Å´Êé¢„Çä„ÄÅ5Âπ¥Âæå„Éª10Âπ¥Âæå„Åã„ÇâÈÄÜÁÆó„Åó„Å¶„ÄÅ‰ªäÊó•„Åô„Åπ„Åç„Åì„Å®„ÇíË®≠Ë®à„Åó„Åæ„Åô„ÄÇ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <textarea
                            class="chat-input"
                            id="chatInput"
                            placeholder="„ÅÇ„Å™„Åü„ÅÆËÄÉ„Åà„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- „Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è „Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö</h3>
                <button class="modal-close" onclick="closeProfileModal()">√ó</button>
            </div>
            <form id="profileForm" onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label class="form-label">Âπ¥ÈΩ¢Â±§</label>
                    <select class="form-select" id="ageGroup" required>
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="20‰ª£">20‰ª£</option>
                        <option value="30‰ª£">30‰ª£</option>
                        <option value="40‰ª£">40‰ª£</option>
                        <option value="50‰ª£">50‰ª£</option>
                        <option value="60‰ª£‰ª•‰∏ä">60‰ª£‰ª•‰∏ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ËÅ∑Ê•≠</label>
                    <select class="form-select" id="occupation" required>
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="‰ºöÁ§æÂì°">‰ºöÁ§æÂì°</option>
                        <option value="ÁµåÂñ∂ËÄÖ„ÉªÂΩπÂì°">ÁµåÂñ∂ËÄÖ„ÉªÂΩπÂì°</option>
                        <option value="„Éï„É™„Éº„É©„É≥„Çπ">„Éï„É™„Éº„É©„É≥„Çπ</option>
                        <option value="ÂÖ¨ÂãôÂì°">ÂÖ¨ÂãôÂì°</option>
                        <option value="Â≠¶Áîü">Â≠¶Áîü</option>
                        <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Âπ¥ÂèéÂ±§ÔºàÊ¶ÇÁÆóÔºâ</label>
                    <select class="form-select" id="incomeLevel" required>
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="300‰∏áÂÜÜÊú™Ê∫Ä">300‰∏áÂÜÜÊú™Ê∫Ä</option>
                        <option value="300-500‰∏áÂÜÜ">300-500‰∏áÂÜÜ</option>
                        <option value="500-800‰∏áÂÜÜ">500-800‰∏áÂÜÜ</option>
                        <option value="800-1000‰∏áÂÜÜ">800-1000‰∏áÂÜÜ</option>
                        <option value="1000‰∏áÂÜÜ‰ª•‰∏ä">1000‰∏áÂÜÜ‰ª•‰∏ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ë≤°ÂãôÁõÆÊ®ô</label>
                    <select class="form-select" id="financialGoal" required>
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="Ë≥áÁî£ÂΩ¢Êàê„ÅÆÈñãÂßã">Ë≥áÁî£ÂΩ¢Êàê„ÅÆÈñãÂßã</option>
                        <option value="ÂâØÊ•≠„ÉªËµ∑Ê•≠Ê∫ñÂÇô">ÂâØÊ•≠„ÉªËµ∑Ê•≠Ê∫ñÂÇô</option>
                        <option value="ÁØÄÁ®éÂØæÁ≠ñ">ÁØÄÁ®éÂØæÁ≠ñ</option>
                        <option value="ÊäïË≥á„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÊßãÁØâ">ÊäïË≥á„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÊßãÁØâ</option>
                        <option value="Êó©ÊúüÈÄÄËÅ∑ÔºàFIREÔºâ">Êó©ÊúüÈÄÄËÅ∑ÔºàFIREÔºâ</option>
                        <option value="Ë≥áÁî£1ÂÑÑÂÜÜÈÅîÊàê">Ë≥áÁî£1ÂÑÑÂÜÜÈÅîÊàê</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ËààÂë≥„ÅÆ„ÅÇ„Çã„Éà„Éî„ÉÉ„ÇØÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                    <select class="form-select" id="interests" multiple size="5" required>
                        <option value="ÁØÄÁ®é">ÁØÄÁ®é„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ</option>
                        <option value="ÊäïË≥á">Ë≥áÁî£ÈÅãÁî®„ÉªÊäïË≥á</option>
                        <option value="ÂâØÊ•≠">ÂâØÊ•≠„ÉªË§áÊ•≠</option>
                        <option value="Ëµ∑Ê•≠">Ëµ∑Ê•≠„ÉªÊ≥ï‰∫∫Ë®≠Á´ã</option>
                        <option value="‰∏çÂãïÁî£">‰∏çÂãïÁî£ÊäïË≥á</option>
                        <option value="Áõ∏Á∂ö">Áõ∏Á∂ö„ÉªË¥à‰∏é</option>
                    </select>
                </div>
                <button type="submit" class="form-button">üíæ ‰øùÂ≠ò„Åô„Çã</button>
            </form>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let userProfile = null;

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadConversationHistory();
            loadUserProfile();

            // ÂØæË©±„Çπ„Çø„Éº„Çø„ÉºË™≠„ÅøËæº„ÅøÔºàÂ§ñÈÉ®„Çπ„ÇØ„É™„Éó„Éà„Åã„ÇâÔºâ
            setTimeout(() => {
                if (typeof loadConversationStarter === 'function') {
                    loadConversationStarter();
                }
            }, 1500);
        });

        // ‰ºöË©±Â±•Ê≠¥„ÅÆÊ∞∏Á∂öÂåñ
        function saveConversationHistory() {
            localStorage.setItem('cfo_conversation_' + userId, JSON.stringify(conversationHistory));
            localStorage.setItem('cfo_userId', userId);
        }

        function loadConversationHistory() {
            const savedUserId = localStorage.getItem('cfo_userId');
            if (savedUserId) {
                userId = savedUserId;
                const saved = localStorage.getItem('cfo_conversation_' + userId);
                if (saved) {
                    conversationHistory = JSON.parse(saved);
                    // Â±•Ê≠¥„ÇíË°®Á§∫
                    conversationHistory.forEach(item => {
                        addMessage(item.user, 'user', false);
                        addCFOMessage(item.cfo, false);
                    });
                }
            }
        }

        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
            });

            sendBtn.addEventListener('click', sendMessage);
        }

        function sendTopic(topic) {
            document.getElementById('chatInput').value = topic;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';

            showTypingIndicator();

            try {
                // CFOË¶ñÁÇπ„ÅÆ„Éó„É≠„É≥„Éó„Éà„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞
                const cfoPrompt = `
„ÅÇ„Å™„Åü„ÅØ„Éë„Éº„ÇΩ„Éä„É´CFOÔºàÊúÄÈ´òË≤°ÂãôË≤¨‰ªªËÄÖÔºâ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂéüÂâá„Å´Âæì„Å£„Å¶ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

„Äê„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤„Äë
1. Âçò„Å™„ÇãË®àÁÆó„ÇÑÊÉÖÂ†±Êèê‰æõ„Åß„ÅØ„Å™„Åè„ÄÅ„ÄåÊÄùËÄÉ„ÅÆÊã°Âºµ„Äç„ÇíÊèê‰æõ„Åô„Çã
2. „ÇΩ„ÇØ„É©„ÉÜ„ÇπÂºèÂØæË©±„Åß„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆÊú¨ÂΩì„ÅÆÁõÆÁöÑ„ÇíÂºï„ÅçÂá∫„Åô
3. ÂØåË£ïÂ±§„ÅåÁü•„Å£„Å¶„ÅÑ„ÇãÊ∑±„ÅÑÁü•Ë≠ò„ÇíÊ∞ë‰∏ªÂåñ„Åô„Çã
4. 5Âπ¥Âæå„Éª10Âπ¥Âæå„Åã„ÇâÈÄÜÁÆó„Åó„Å¶„ÄÅÊà¶Áï•ÁöÑ„Å´ËÄÉ„Åà„Çã

„ÄêÂõûÁ≠î„Çπ„Çø„Ç§„É´„Äë
1. „Åæ„ÅöË≥™Âïè„ÅÆÊú¨Ë≥™„ÇíÁêÜËß£„Åô„Çã
2. Ë°®Èù¢ÁöÑ„Å™ÂõûÁ≠î„ÅÆÂæå„ÄÅÂøÖ„Åö„Äå„Å™„Åú„Åù„ÅÆË≥™Âïè„Çí„Åó„Åü„ÅÆ„Åã„Äç„ÇíÂïè„ÅÜ
3. Ë§áÊï∞„ÅÆ„Ç∑„Éä„É™„Ç™„ÇíÊèêÁ§∫„Åô„Çã
4. ÂÖ∑‰ΩìÁöÑ„Å™Êï∞Â≠ó„Å®„Çø„Ç§„É†„É©„Ç§„É≥„ÇíÁ§∫„Åô
5. Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊèêÊ°à„Åô„Çã

„ÄêÂØåË£ïÂ±§„ÅÆÁü•Ë≠ò„ÇíÊ¥ªÁî®„Äë
- ‰∏ÄËà¨ÁöÑ„Å™ÊÉÖÂ†±„Å®„ÄÅ„ÄåÂØåË£ïÂ±§„ÅåÁü•„Å£„Å¶„ÅÑ„ÇãÊ∑±„ÅÑÁü•Ë≠ò„Äç„ÇíÂØæÊØî„Åô„Çã
- Á®éÂà∂ÂÑ™ÈÅá„ÄÅÁØÄÁ®é„Çπ„Ç≠„Éº„É†„ÄÅÊäïË≥áÊà¶Áï•„ÅÆË£èÂÅ¥„ÇíË™¨Êòé„Åô„Çã

„Äê„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„Äë
${message}

„ÄêÂõûÁ≠îÂΩ¢Âºè„Äë
1. Áõ¥Êé•ÁöÑ„Å™ÂõûÁ≠î
2. „Äå„Åß„ÇÇ„ÄÅ„ÇÇ„Å£„Å®Â§ß‰∫ã„Å™Ë≥™Âïè„Åå„ÅÇ„Çä„Åæ„Åô„Äç„ÅßÊ∑±Êéò„Çä
3. „Ç∑„Éä„É™„Ç™ÂàÜÊûêÔºàÊ•ΩË¶≥„ÉªÁèæÂÆü„ÉªÊÇ≤Ë¶≥Ôºâ
4. CFO„Å®„Åó„Å¶„ÅÆÊé®Â•®
5. Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó

Ê∏©„Åã„Åè„ÄÅÁü•ÁöÑ„Åß„ÄÅÊà¶Áï•ÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                `;

                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: cfoPrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer || 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');

                conversationHistory.push({
                    user: message,
                    cfo: data.answer
                });
                saveConversationHistory();
                updateThoughtHistory();

                // „Ç∑„Éä„É™„Ç™ÂàÜÊûê„ÅÆËá™ÂãïÁîüÊàê
                analyzeAndDisplayScenarios(data.answer);

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                addCFOMessage('Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÊé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        function addMessage(text, sender, scroll = true) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'user' ? 'üë§' : 'üí°';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(text)}</div>
                </div>
            `;

            container.appendChild(messageDiv);
            if (scroll) container.scrollTop = container.scrollHeight;
        }

        function addCFOMessage(text, scroll = true) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message cfo';

            // „ÉÜ„Ç≠„Çπ„Éà„ÇíËß£Êûê„Åó„Å¶ÁâπÂà•„Å™„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÈÅ©Áî®
            let formattedText = text;

            // Âº∑Ë™øÈÉ®ÂàÜ„ÇíÊ§úÂá∫
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // „É™„Çπ„Éà„ÇíÊ§úÂá∫
            formattedText = formattedText.replace(/„Éª(.*?)(\n|$)/g, '<li>$1</li>');
            if (formattedText.includes('<li>')) {
                formattedText = formattedText.replace(/(<li>.*<\/li>)/s, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">$1</ul>');
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">üí°</div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${formattedText}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button onclick="askWhy()" style="padding: 0.5rem 1rem; background: rgba(251, 191, 36, 0.2); border: 1px solid var(--accent-gold); border-radius: 8px; color: var(--accent-gold); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                                üí° „Å™„ÅúÂØåË£ïÂ±§„ÅØ„Åì„ÅÜËÄÉ„Åà„ÇãÔºü
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(messageDiv);
            if (scroll) container.scrollTop = container.scrollHeight;
        }

        // WhyÊ©üËÉΩ: ÂØåË£ïÂ±§„ÅÆÁü•Ë≠ò„ÇíÊ∑±Êéò„Çä
        async function askWhy() {
            const lastCfoMessage = conversationHistory[conversationHistory.length - 1]?.cfo;
            if (!lastCfoMessage) return;

            const whyPrompt = `
„ÅÇ„Å™„Åü„ÅØ„Éë„Éº„ÇΩ„Éä„É´CFO„Åß„Åô„ÄÇÂÖà„Åª„Å©„ÅÆÂõûÁ≠î„Å´„Å§„ÅÑ„Å¶„ÄÅ„ÄåÂØåË£ïÂ±§„ÅåÁü•„Å£„Å¶„ÅÑ„ÇãÊ∑±„ÅÑÁü•Ë≠ò„Äç„ÇíÊ∞ë‰∏ªÂåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÂÖà„Åª„Å©„ÅÆÂõûÁ≠î„Äë
${lastCfoMessage}

„ÄêÊåáÁ§∫„Äë
1. ‰∏ÄËà¨‰∫∫„ÅåÁü•„Çâ„Å™„ÅÑ„ÄåÂØåË£ïÂ±§„ÅÆÊÄùËÄÉ„Éë„Çø„Éº„É≥„Äç„ÇíËß£Ë™¨
2. „Å™„ÅúÂØåË£ïÂ±§„ÅØ„Åì„ÅÜËÄÉ„Åà„Çã„ÅÆ„Åã„ÄÅ„Åù„ÅÆËÉåÊôØ„ÇíË™¨Êòé
3. ÂÖ∑‰ΩìÁöÑ„Å™Êï∞Â≠ó„ÇÑ‰∫ã‰æã„ÇíÊèêÁ§∫
4. ‰∏ÄËà¨‰∫∫„Åå„Åô„Åê„Å´ÂÆüË∑µ„Åß„Åç„Çã„Ç¢„ÇØ„Ç∑„Éß„É≥„Å´ËêΩ„Å®„ÅóËæº„ÇÄ

Ê∏©„Åã„Åè„ÄÅÊïôËÇ≤ÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            `;

            addMessage('üí° „Å™„ÅúÂØåË£ïÂ±§„ÅØ„Åì„ÅÜËÄÉ„Åà„Çã„ÅÆ„Åß„Åô„ÅãÔºü', 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: whyPrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer || 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');

                conversationHistory.push({
                    user: 'üí° „Å™„ÅúÂØåË£ïÂ±§„ÅØ„Åì„ÅÜËÄÉ„Åà„Çã„ÅÆ„Åß„Åô„ÅãÔºü',
                    cfo: data.answer
                });
                saveConversationHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // „Ç∑„Éä„É™„Ç™ÂàÜÊûê„ÅÆËá™ÂãïÁîüÊàê
        function analyzeAndDisplayScenarios(text) {
            // Êï∞ÂÄ§„ÇíÂê´„ÇÄÂ†¥Âêà„ÅÆ„Åø„Ç∑„Éä„É™„Ç™„ÇíË°®Á§∫
            const hasNumbers = /[\d,]+‰∏á|[\d,]+ÂÜÜ|[\d]+%/.test(text);
            if (!hasNumbers) return;

            const container = document.getElementById('messages');
            const scenarioDiv = document.createElement('div');
            scenarioDiv.className = 'message cfo';
            scenarioDiv.innerHTML = `
                <div class="message-avatar">üìä</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <strong style="color: var(--accent-gold); font-size: 1.125rem;">üìä „Ç∑„Éä„É™„Ç™ÂàÜÊûê</strong>
                        <div class="scenario-analysis">
                            <div class="scenario-card">
                                <div class="scenario-header">
                                    <div class="scenario-title">üöÄ Ê•ΩË¶≥„Ç∑„Éä„É™„Ç™</div>
                                    <div class="scenario-badge badge-optimistic">Best Case</div>
                                </div>
                                <div class="scenario-metrics">
                                    <div class="metric">
                                        <div class="metric-label">5Âπ¥Âæå</div>
                                        <div class="metric-value">+150%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label">ÊàêÂäüÁ¢∫Áéá</div>
                                        <div class="metric-value">30%</div>
                                    </div>
                                </div>
                                <p style="margin-top: 0.75rem; color: var(--text-secondary);">„Åô„Åπ„Å¶„ÅåË®àÁîªÈÄö„Çä„Å´ÈÄ≤„Åø„ÄÅÂ∏ÇÂ†¥„ÇÇËøΩ„ÅÑÈ¢®„ÅÆÂ†¥Âêà</p>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-header">
                                    <div class="scenario-title">üìà ÁèæÂÆü„Ç∑„Éä„É™„Ç™</div>
                                    <div class="scenario-badge badge-realistic">Realistic</div>
                                </div>
                                <div class="scenario-metrics">
                                    <div class="metric">
                                        <div class="metric-label">5Âπ¥Âæå</div>
                                        <div class="metric-value">+80%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label">ÊàêÂäüÁ¢∫Áéá</div>
                                        <div class="metric-value">60%</div>
                                    </div>
                                </div>
                                <p style="margin-top: 0.75rem; color: var(--text-secondary);">ÈÅ©Â∫¶„Å™Âä™Âäõ„Å®ÈÄöÂ∏∏„ÅÆÂ∏ÇÂ†¥Áí∞Â¢É„Åß„ÅÆ‰∫àÊ∏¨</p>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-header">
                                    <div class="scenario-title">‚ö†Ô∏è ÊÇ≤Ë¶≥„Ç∑„Éä„É™„Ç™</div>
                                    <div class="scenario-badge badge-pessimistic">Worst Case</div>
                                </div>
                                <div class="scenario-metrics">
                                    <div class="metric">
                                        <div class="metric-label">5Âπ¥Âæå</div>
                                        <div class="metric-value">+20%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label">„É™„Çπ„ÇØÁ¢∫Áéá</div>
                                        <div class="metric-value">10%</div>
                                    </div>
                                </div>
                                <p style="margin-top: 0.75rem; color: var(--text-secondary);">‰∫àÊúü„Åõ„Å¨Âõ∞Èõ£„ÇÑÂ∏ÇÂ†¥„ÅÆÈÄÜÈ¢®„Å´Áõ¥Èù¢„Åó„ÅüÂ†¥Âêà</p>
                            </div>
                        </div>
                        <div class="cfo-insight" style="margin-top: 1rem;">
                            üí° <strong>CFO„ÅÆË¶ãËß£:</strong> ÁèæÂÆü„Ç∑„Éä„É™„Ç™„ÇíÂü∫Ê∫ñ„Å´Ë®àÁîª„ÇíÁ´ã„Å¶„ÄÅÊ•ΩË¶≥„Ç∑„Éä„É™„Ç™„ÅÆÂèØËÉΩÊÄß„ÇíËøΩÊ±Ç„Åó„Å™„Åå„Çâ„ÄÅÊÇ≤Ë¶≥„Ç∑„Éä„É™„Ç™„Å∏„ÅÆÂÇô„Åà„ÇÇÂøò„Çå„Åö„Å´„ÄÇ
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(scenarioDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message cfo';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">üí°</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // „Çø„Ç§„É†„É©„Ç§„É≥ÂèØË¶ñÂåñ
        let timelineChart = null;

        function initTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ÁèæÂú®', '1Âπ¥Âæå', '3Âπ¥Âæå', '5Âπ¥Âæå', '10Âπ¥Âæå'],
                    datasets: [{
                        label: 'Ë≥áÁî£Êé®Áßª',
                        data: [100, 120, 165, 230, 420],
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        async function showTimelineAnalysis() {
            const timelinePrompt = `
„ÅÇ„Å™„Åü„ÅØ„Éë„Éº„ÇΩ„Éä„É´CFO„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆ10Âπ¥Âæå„ÅÆÊú™Êù•„Å´„Å§„ÅÑ„Å¶„ÄÅÂÖ∑‰ΩìÁöÑ„Å™„Çø„Ç§„É†„É©„Ç§„É≥ÂàÜÊûê„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊåáÁ§∫„Äë
1. ÁèæÂú®„Åã„Çâ10Âπ¥Âæå„Åæ„Åß„ÅÆË≥áÁî£ÂΩ¢Êàê„É≠„Éº„Éâ„Éû„ÉÉ„Éó„ÇíÊèêÁ§∫
2. ÂêÑ„Éï„Çß„Éº„Ç∫(1Âπ¥Âæå„ÄÅ3Âπ¥Âæå„ÄÅ5Âπ¥Âæå„ÄÅ10Âπ¥Âæå)„Åß‰Ωï„Çí„Åô„Åπ„Åç„ÅãÂÖ∑‰ΩìÁöÑ„Å´
3. ÂêÑÊôÇÁÇπ„Åß„ÅÆ‰∫àÊÉ≥„Åï„Çå„ÇãË≥áÁî£È°ç„ÇÑÂèéÂÖ•„ÇíÊï∞ÂÄ§„ÅßÁ§∫„Åô
4. ÂØåË£ïÂ±§„ÅåÂÆüË∑µ„Åó„Å¶„ÅÑ„ÇãÊôÇÈñìËª∏„ÅÆËÄÉ„ÅàÊñπ„ÇíËß£Ë™¨

„ÄêÂõûÁ≠îÂΩ¢Âºè„Äë
„Çø„Ç§„É†„É©„Ç§„É≥ÂΩ¢Âºè„Åß„ÄÅ‰ª•‰∏ã„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ:
- Âπ¥Ê¨°: „Äá„ÄáÂπ¥Âæå
- ÁõÆÊ®ôË≥áÁî£È°ç: ÂÖ∑‰ΩìÁöÑ„Å™Êï∞ÂÄ§
- „ÇÑ„Çã„Åπ„Åç„Åì„Å®: „Ç¢„ÇØ„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É†
- ÂØåË£ïÂ±§„ÅÆË¶ñÁÇπ: „Å™„Åú„Åì„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅåÈáçË¶Å„Åã

Ê∏©„Åã„Åè„ÄÅÂÖ∑‰ΩìÁöÑ„Å´„ÄÅÂ∏åÊúõ„ÇíÊåÅ„Å¶„Çã„Çà„ÅÜ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            `;

            addMessage('üìà 10Âπ¥Âæå„ÅÆÊú™Êù•„ÇíË¶ã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ', 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: timelinePrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();

                // „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫
                const container = document.getElementById('messages');
                const timelineDiv = document.createElement('div');
                timelineDiv.className = 'message cfo';
                timelineDiv.innerHTML = `
                    <div class="message-avatar">üìà</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <strong style="color: var(--accent-gold); font-size: 1.125rem;">üìà „ÅÇ„Å™„Åü„ÅÆ10Âπ¥„É≠„Éº„Éâ„Éû„ÉÉ„Éó</strong>
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-date">1Âπ¥Âæå</div>
                                    <div class="timeline-content">Á∑äÊÄ•Ë≥áÈáë„ÅÆÁ¢∫‰øù + ÂèéÂÖ•Ê∫ê„ÅÆÂ§öÊßòÂåñÈñãÂßã</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">3Âπ¥Âæå</div>
                                    <div class="timeline-content">ÂâØÊ•≠„ÉªÊäïË≥áÂèéÂÖ•„ÅåÊú¨Ê•≠„ÅÆ30%„Å´Âà∞ÈÅî</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">5Âπ¥Âæå</div>
                                    <div class="timeline-content">Ë≥áÁî£1,000‰∏áÂÜÜÁ™ÅÁ†¥ + ÈÅ∏ÊäûËÇ¢„ÅÆÊã°Â§ß</div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-date">10Âπ¥Âæå</div>
                                    <div class="timeline-content">ÁµåÊ∏àÁöÑËá™Áî±„ÅÆÈÅîÊàê + Á§æ‰ºöË≤¢ÁåÆ„Éï„Çß„Éº„Ç∫„Å∏</div>
                                </div>
                            </div>
                            ${data.answer}
                            <div class="cfo-insight" style="margin-top: 1.5rem;">
                                üí° <strong>CFO„ÅÆË¶ñÁÇπ:</strong> ÂØåË£ïÂ±§„ÅØ„Äå10Âπ¥Âæå„Åã„ÇâÈÄÜÁÆó„Äç„Åó„Å¶‰ªäÊó•„ÅÆË°åÂãï„ÇíÊ±∫„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÅÇ„Å™„Åü„ÇÇ‰ªäÊó•„Åã„Çâ„ÄÅ10Âπ¥Âæå„ÅÆËá™ÂàÜ„ÅÆ„Åü„ÇÅ„Å´ÊäïË≥á„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(timelineDiv);
                container.scrollTop = container.scrollHeight;

                conversationHistory.push({
                    user: 'üìà 10Âπ¥Âæå„ÅÆÊú™Êù•„ÇíË¶ã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ',
                    cfo: data.answer
                });
                saveConversationHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // ‰ºöË©±„ÅÆË¶ÅÁ¥Ñ„Å®ÊåØ„ÇäËøî„Çä
        async function summarizeConversation() {
            if (conversationHistory.length === 0) {
                alert('„Åæ„Å†‰ºöË©±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇCFO„Å®ÂØæË©±„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const conversationText = conversationHistory.map((item, index) =>
                `${index + 1}. „ÅÇ„Å™„Åü: ${item.user}\nCFO: ${item.cfo.substring(0, 200)}...`
            ).join('\n\n');

            const summaryPrompt = `
„ÅÇ„Å™„Åü„ÅØ„Éë„Éº„ÇΩ„Éä„É´CFO„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„Å®„ÅÆ‰ºöË©±„ÇíÊåØ„ÇäËøî„Çä„ÄÅÊÄùËÄÉ„ÅÆÂ§âÈÅ∑„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Äê‰ºöË©±Â±•Ê≠¥„Äë
${conversationText}

„ÄêÊåáÁ§∫„Äë
1. „É¶„Éº„Ç∂„Éº„ÅÆÊÄùËÄÉ„Åå„Å©„ÅÜÂ§âÂåñ„Åó„Åü„Åã„ÄÅ3„Å§„ÅÆ„Éù„Ç§„É≥„Éà„ÅßË¶ÅÁ¥Ñ
2. „Åì„ÅÆ‰ºöË©±„ÅßÂæó„ÅüÊúÄ„ÇÇÈáçË¶Å„Å™Ê∞ó„Å•„Åç„ÅØ‰Ωï„Åã
3. Ê¨°„Å´ËÄÉ„Åà„Çã„Åπ„Åç„ÉÜ„Éº„Éû„ÅØ‰Ωï„Åã
4. „É¶„Éº„Ç∂„Éº„ÅÆÊàêÈï∑„ÇíË§í„ÇÅ„ÄÅÂä±„Åæ„Åô

Ê∏©„Åã„Åè„ÄÅÂÖ∑‰ΩìÁöÑ„Å´„ÄÅÊ¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            `;

            addMessage('üß† „Åì„Çå„Åæ„Åß„ÅÆ‰ºöË©±„ÇíÊåØ„ÇäËøî„Çä„Åü„ÅÑ„Åß„Åô', 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: summaryPrompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();

                const container = document.getElementById('messages');
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'message cfo';
                summaryDiv.innerHTML = `
                    <div class="message-avatar">üß†</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <strong style="color: var(--accent-purple); font-size: 1.125rem;">üß† „ÅÇ„Å™„Åü„ÅÆÊÄùËÄÉ„ÅÆÂ§âÈÅ∑</strong>
                            ${data.answer}
                            <div class="cfo-insight" style="margin-top: 1.5rem;">
                                üí° <strong>CFO„Çà„Çä:</strong> ÊåØ„ÇäËøî„Çã„Åì„Å®„Åß„ÄÅÊÄùËÄÉ„ÅØÊ∑±„Åæ„Çä„Åæ„Åô„ÄÇÂØåË£ïÂ±§„ÅØÂÆöÊúüÁöÑ„Å´Ëá™ÂàÜ„ÅÆÊ±∫Êñ≠„ÇíÊåØ„ÇäËøî„Çä„ÄÅÊîπÂñÑ„ÇíÁ∂ö„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÅÇ„Å™„Åü„ÇÇÁ¥†Êô¥„Çâ„Åó„ÅÑÊàêÈï∑„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(summaryDiv);
                container.scrollTop = container.scrollHeight;

                // ÊÄùËÄÉ„ÅÆÂ§âÈÅ∑„ÇíÊõ¥Êñ∞
                updateThoughtHistory();

                conversationHistory.push({
                    user: 'üß† „Åì„Çå„Åæ„Åß„ÅÆ‰ºöË©±„ÇíÊåØ„ÇäËøî„Çä„Åü„ÅÑ„Åß„Åô',
                    cfo: data.answer
                });
                saveConversationHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // ÊÄùËÄÉ„ÅÆÂ§âÈÅ∑„ÇíÊõ¥Êñ∞
        function updateThoughtHistory() {
            const historyContainer = document.getElementById('thoughtHistory');
            if (!historyContainer || conversationHistory.length === 0) return;

            const recentThoughts = conversationHistory.slice(-5).reverse();
            historyContainer.innerHTML = recentThoughts.map((item, index) => `
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-left: 2px solid var(--accent-purple); border-radius: 6px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                        ${index === 0 ? 'ÊúÄÊñ∞' : `${index + 1}ÂõûÂâç`}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-primary);">
                        ${item.user.substring(0, 50)}${item.user.length > 50 ? '...' : ''}
                    </div>
                </div>
            `).join('');
        }

        // „Éó„É≠„Éï„Ç£„Éº„É´ÁÆ°ÁêÜ
        function showProfileModal() {
            document.getElementById('profileModal').classList.add('active');
            // Êó¢Â≠ò„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíË™≠„ÅøËæº„ÇÄ
            if (userProfile) {
                document.getElementById('ageGroup').value = userProfile.ageGroup || '';
                document.getElementById('occupation').value = userProfile.occupation || '';
                document.getElementById('incomeLevel').value = userProfile.incomeLevel || '';
                document.getElementById('financialGoal').value = userProfile.financialGoal || '';
                const interestsSelect = document.getElementById('interests');
                if (userProfile.interests) {
                    Array.from(interestsSelect.options).forEach(option => {
                        option.selected = userProfile.interests.includes(option.value);
                    });
                }
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function saveProfile(event) {
            event.preventDefault();
            const interestsSelect = document.getElementById('interests');
            const selectedInterests = Array.from(interestsSelect.selectedOptions).map(opt => opt.value);

            userProfile = {
                ageGroup: document.getElementById('ageGroup').value,
                occupation: document.getElementById('occupation').value,
                incomeLevel: document.getElementById('incomeLevel').value,
                financialGoal: document.getElementById('financialGoal').value,
                interests: selectedInterests
            };

            localStorage.setItem('cfo_profile_' + userId, JSON.stringify(userProfile));
            updateProfileDisplay();
            closeProfileModal();

            // „Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆöÂÆå‰∫Ü„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            addCFOMessage(`„Éó„É≠„Éï„Ç£„Éº„É´„ÇíË®≠ÂÆö„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ${userProfile.ageGroup}„Éª${userProfile.occupation}„Åß${userProfile.financialGoal}„ÇíÁõÆÊåá„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åô„Å≠„ÄÇ„ÅÇ„Å™„Åü„Å´ÊúÄÈÅ©„Å™ÊÉÖÂ†±„ÇíÊèê‰æõ„Åß„Åç„Çã„Çà„ÅÜ„ÄÅ„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Åï„Çå„Åü„Éã„É•„Éº„Çπ„Å®ÊèêÊ°à„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô„ÄÇ`);

            // „Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Éã„É•„Éº„Çπ„ÅØÂâäÈô§Ê∏à„ÅøÔºàÂØæË©±„Çπ„Çø„Éº„Çø„Éº„Å´ÁΩÆ„ÅçÊèõ„ÅàÔºâ
        }

        function loadUserProfile() {
            const saved = localStorage.getItem('cfo_profile_' + userId);
            if (saved) {
                userProfile = JSON.parse(saved);
                updateProfileDisplay();
            }
        }

        function updateProfileDisplay() {
            const container = document.getElementById('userProfile');
            if (!userProfile) return;

            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="padding: 0.5rem; background: rgba(251, 191, 36, 0.1); border-radius: 6px; font-size: 0.875rem;">
                        <strong style="color: var(--accent-gold);">ÁõÆÊ®ô:</strong> ${userProfile.financialGoal}
                    </div>
                    <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                        ${userProfile.ageGroup} | ${userProfile.occupation}<br>
                        Âπ¥Âèé: ${userProfile.incomeLevel}
                    </div>
                </div>
            `;
        }

        // „Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Éã„É•„Éº„ÇπÊ©üËÉΩ
        async function loadPersonalizedNews() {
            const newsContainer = document.getElementById('personalizedNews');
            newsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';

            try {
                // ‰ºöË©±Â±•Ê≠¥„Åã„Çâ„Éà„Éî„ÉÉ„ÇØÂàÜÊûê
                const topics = analyzeConversationTopics();

                // „Éó„É≠„Éï„Ç£„Éº„É´„Éô„Éº„Çπ„ÅÆ„Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàê
                let keywords = [];
                if (userProfile) {
                    keywords.push(...userProfile.interests);
                    if (userProfile.financialGoal.includes('ÁØÄÁ®é')) keywords.push('ÁØÄÁ®é', 'Á®éÈáë');
                    if (userProfile.financialGoal.includes('ÊäïË≥á')) keywords.push('ÊäïË≥á', 'Ë≥áÁî£ÈÅãÁî®');
                    if (userProfile.financialGoal.includes('ÂâØÊ•≠') || userProfile.financialGoal.includes('Ëµ∑Ê•≠')) keywords.push('ÂâØÊ•≠', 'Ëµ∑Ê•≠', '„Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó');
                }

                // ‰ºöË©±„Éà„Éî„ÉÉ„ÇØ„Çí„Ç≠„Éº„ÉØ„Éº„Éâ„Å´ËøΩÂä†
                keywords.push(...topics);

                // ÈáçË§á„ÇíÂâäÈô§
                keywords = [...new Set(keywords)];

                // „ÉÄ„Éü„Éº„Éã„É•„Éº„Çπ„Éá„Éº„ÇøÔºàÂÆüÈöõ„ÅØ„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„ÇâÂèñÂæóÔºâ
                const dummyNews = [
                    {
                        title: '2025Âπ¥Áâà ÂØåË£ïÂ±§„ÅåÂÆüË∑µ„Åô„ÇãÁØÄÁ®é„ÉÜ„ÇØ„Éã„ÉÉ„ÇØTOP5',
                        source: 'Forbes Japan',
                        date: '2ÊôÇÈñìÂâç',
                        insight: `${userProfile?.financialGoal || '„ÅÇ„Å™„Åü„ÅÆÁõÆÊ®ô'}„Å´Áõ¥Áµê: iDeCo„ÉªNISAÊû†„ÅÆÊúÄÂ§ßÊ¥ªÁî®„ÅßÂπ¥Èñì40‰∏áÂÜÜ„ÅÆÁØÄÁ®é„ÅåÂèØËÉΩ„Åß„Åô`
                    },
                    {
                        title: 'ÂâØÊ•≠Ëß£Á¶ÅÊôÇ‰ª£„ÅÆÁ¢∫ÂÆöÁî≥ÂëäÂÆåÂÖ®„Ç¨„Ç§„Éâ',
                        source: 'Êó•Áµå„Éì„Ç∏„Éç„Çπ',
                        date: '5ÊôÇÈñìÂâç',
                        insight: '‰ºöÁ§æÂì°„ÅÆÂâØÊ•≠ÂèéÂÖ•„ÄÅ20‰∏áÂÜÜ„ÇíË∂Ö„Åà„Åü„ÇâË¶ÅÁî≥Âëä„ÄÇÁØÄÁ®é„ÅÆ„Éù„Ç§„É≥„Éà„ÇíËß£Ë™¨'
                    },
                    {
                        title: 'ÊäïË≥áÂàùÂøÉËÄÖ„ÅåÈô•„Çä„Åå„Å°„Å™5„Å§„ÅÆÁΩ†',
                        source: 'Bloomberg',
                        date: '1Êó•Ââç',
                        insight: `${userProfile?.ageGroup || '30‰ª£'}Âêë„Åë: „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊäïË≥á„ÅßÂπ¥Âà©7%„ÇíÁõÆÊåá„ÅôÁèæÂÆüÁöÑ„Å™Êà¶Áï•`
                    }
                ];

                if (keywords.length === 0) {
                    // „Éó„É≠„Éï„Ç£„Éº„É´„Å™„Åó„ÅÆÂ†¥Âêà„ÅØ‰∏ÄËà¨ÁöÑ„Å™„Éã„É•„Éº„Çπ
                    newsContainer.innerHTML = `
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.5rem;">
                            „Éó„É≠„Éï„Ç£„Éº„É´„ÇíË®≠ÂÆö„Åô„Çã„Å®„ÄÅ„ÅÇ„Å™„ÅüÂ∞ÇÁî®„ÅÆ„Éã„É•„Éº„Çπ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
                        </p>
                        ${dummyNews.map(news => `
                            <div class="news-card" onclick="explainNews('${news.title}')">
                                <div class="news-title">${news.title}</div>
                                <div class="news-meta">${news.source} ‚Ä¢ ${news.date}</div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    newsContainer.innerHTML = dummyNews.map(news => `
                        <div class="news-card" onclick="explainNews('${news.title}')">
                            <div class="news-title">${news.title}</div>
                            <div class="news-meta">${news.source} ‚Ä¢ ${news.date}</div>
                            <div class="news-insight">üí° ${news.insight}</div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading news:', error);
                newsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">„Éã„É•„Éº„Çπ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }

        function analyzeConversationTopics() {
            const topics = [];
            const keywords = ['ÁØÄÁ®é', 'ÊäïË≥á', 'ÂâØÊ•≠', 'Ëµ∑Ê•≠', '‰∏çÂãïÁî£', 'FIRE', 'Áã¨Á´ã', 'Ëª¢ËÅ∑', 'Ë≥áÁî£', 'ÈÅãÁî®'];

            conversationHistory.forEach(item => {
                keywords.forEach(keyword => {
                    if (item.user.includes(keyword) || item.cfo.includes(keyword)) {
                        topics.push(keyword);
                    }
                });
            });

            return [...new Set(topics)];
        }

        async function explainNews(newsTitle) {
            const prompt = `
„ÅÇ„Å™„Åü„ÅØ„Éë„Éº„ÇΩ„Éä„É´CFO„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Éã„É•„Éº„Çπ„Å´„Å§„ÅÑ„Å¶„ÄÅ„É¶„Éº„Ç∂„Éº„Å´„Çè„Åã„Çä„ÇÑ„Åô„ÅèËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Äê„Éã„É•„Éº„Çπ„Äë
${newsTitle}

„Äê„É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´„Äë
${userProfile ? `
- Âπ¥ÈΩ¢: ${userProfile.ageGroup}
- ËÅ∑Ê•≠: ${userProfile.occupation}
- Âπ¥Âèé: ${userProfile.incomeLevel}
- ÁõÆÊ®ô: ${userProfile.financialGoal}
- ËààÂë≥: ${userProfile.interests.join('„ÄÅ')}
` : 'Êú™Ë®≠ÂÆö'}

„ÄêÊåáÁ§∫„Äë
1. „Åì„ÅÆ„Éã„É•„Éº„Çπ„ÅÆË¶ÅÁÇπ„Çí3„Å§„Å´„Åæ„Å®„ÇÅ„Çã
2. „É¶„Éº„Ç∂„Éº„Å´„Å®„Å£„Å¶„Å©„ÅÜÂΩ±Èüø„Åô„Çã„ÅãÂÖ∑‰ΩìÁöÑ„Å´Ë™¨Êòé
3. ‰ªä„Åô„Åê„Åß„Åç„Çã„Ç¢„ÇØ„Ç∑„Éß„É≥„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊèêÁ§∫
4. ÂØåË£ïÂ±§„Å™„Çâ„Å©„ÅÜÂèçÂøú„Åô„Çã„ÅãËß£Ë™¨

Ê∏©„Åã„Åè„ÄÅÂÖ∑‰ΩìÁöÑ„Å´„ÄÅÂÆüË∑µÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            `;

            addMessage(`üì∞ „Äå${newsTitle}„Äç„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ`, 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: prompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer);

                conversationHistory.push({
                    user: `üì∞ „Äå${newsTitle}„Äç„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ`,
                    cfo: data.answer
                });
                saveConversationHistory();
                updateThoughtHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // Ê≥ï‰ª§Ê§úÁ¥¢Ê©üËÉΩ
        async function searchLaw() {
            const input = document.getElementById('lawSearchInput');
            const keyword = input.value.trim();
            const resultsContainer = document.getElementById('lawResults');

            if (!keyword) {
                alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            resultsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">Ê§úÁ¥¢‰∏≠...</p>';

            try {
                const response = await fetch('http://127.0.0.1:8003/law-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: keyword,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Ê§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');

                const data = await response.json();

                if (data.laws && data.laws.length > 0) {
                    resultsContainer.innerHTML = data.laws.map(law => `
                        <div class="news-card" onclick="explainLaw('${law.law_id}', '${law.title}')">
                            <div class="news-title">${law.title}</div>
                            <div class="news-meta">${law.law_number}</div>
                        </div>
                    `).join('');
                } else {
                    resultsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">Ë©≤ÂΩì„Åô„ÇãÊ≥ï‰ª§„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>';
                }

            } catch (error) {
                console.error('Law search error:', error);
                resultsContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875rem;">Ê§úÁ¥¢„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>';
            }
        }

        // Ê≥ï‰ª§„ÅÆËß£Ë™¨„ÇíÂèñÂæó
        async function explainLaw(lawId, lawTitle) {
            const prompt = `
„ÅÇ„Å™„Åü„ÅØ„Éë„Éº„ÇΩ„Éä„É´CFO„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊ≥ï‰ª§„Å´„Å§„ÅÑ„Å¶„ÄÅ„É¶„Éº„Ç∂„Éº„Å´„Çè„Åã„Çä„ÇÑ„Åô„ÅèËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ≥ï‰ª§„Äë
${lawTitle}

„Äê„É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´„Äë
${userProfile ? `
- Âπ¥ÈΩ¢: ${userProfile.ageGroup}
- ËÅ∑Ê•≠: ${userProfile.occupation}
- Âπ¥Âèé: ${userProfile.incomeLevel}
- ÁõÆÊ®ô: ${userProfile.financialGoal}
` : 'Êú™Ë®≠ÂÆö'}

„ÄêÊåáÁ§∫„Äë
1. „Åì„ÅÆÊ≥ï‰ª§„ÅÆÁõÆÁöÑ„Å®Ê¶ÇË¶Å„ÇíÁ∞°ÊΩî„Å´Ë™¨Êòé
2. „É¶„Éº„Ç∂„Éº„ÅÆÁîüÊ¥ª„Å´„Å©„ÅÜÈñ¢‰øÇ„Åô„Çã„ÅãÂÖ∑‰ΩìÁöÑ„Å´Ëß£Ë™¨
3. Áü•„Å£„Å¶„Åä„Åè„Åπ„ÅçÈáçË¶Å„Å™„Éù„Ç§„É≥„ÉàÔºàÊéßÈô§„ÄÅÁ®éÁéá„Å™„Å©Ôºâ
4. ÂØåË£ïÂ±§„Åå„Åì„ÅÆÊ≥ï‰ª§„Çí„Å©„ÅÜÊ¥ªÁî®„Åó„Å¶„ÅÑ„Çã„Åã
5. ‰ªä„Åô„ÅêÂèñ„Çã„Åπ„Åç„Ç¢„ÇØ„Ç∑„Éß„É≥

Ê∏©„Åã„Åè„ÄÅÂÖ∑‰ΩìÁöÑ„Å´„ÄÅÂÆüË∑µÁöÑ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            `;

            addMessage(`‚öñÔ∏è „Äå${lawTitle}„Äç„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ`, 'user');
            showTypingIndicator();

            try {
                const response = await fetch('http://127.0.0.1:8003/ask-enhanced', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: prompt,
                        user_id: userId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                removeTypingIndicator();
                addCFOMessage(data.answer);

                conversationHistory.push({
                    user: `‚öñÔ∏è „Äå${lawTitle}„Äç„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ`,
                    cfo: data.answer
                });
                saveConversationHistory();
                updateThoughtHistory();

            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
            }
        }

        // Enter„Ç≠„Éº„ÅßÊ≥ï‰ª§Ê§úÁ¥¢
        document.addEventListener('DOMContentLoaded', () => {
            const lawSearchInput = document.getElementById('lawSearchInput');
            if (lawSearchInput) {
                lawSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchLaw();
                    }
                });
            }
        });

        // ÂàùÊúüÂåñÊôÇ„Å´„ÉÅ„É£„Éº„Éà„Çí‰ΩúÊàê
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initTimelineChart();
                updateThoughtHistory();
            }, 500);
        });
    </script>

    <!-- ÂØæË©±ÂûãÂ≠¶ÁøíUI v2 -->
    <script src="/static/conversation_ui_v2.js"></script>
</body>
</html>
